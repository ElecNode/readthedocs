14.OpenWrt-UPnP
===========================================================

14.1UPnP简介
-----------------------------------------------------------

14.1.1起源
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

通用即插即用(UniversalPlugandPlay,UPnP)是一种分布式、开放的网络架构,此标准由微软公司于1999年提出,由非盈利的通用即插即用论坛(UPnPForum)负责体系架构和标准的维护和更新升级,此标准现已开放。

14.1.2概述
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

UPnP主要用于智能设备、无线设备、个人计算机之间的互联互通。此协议在使用过程中不需要任何驱动,可以在各种操作系统上运行。凡是可以连接局域网的场所都可以利用UPnP协议实现设备的互联互通,比如家庭、办公室、娱乐场所等地方。UPnP在即插即用的基础上进行了扩展,对家庭或企业中智能设备的联网过程进行了简化。当符合UPnP协议和技术的设备以物理形式连接到局域网之后,它们可以通过网络自动彼此连接在一起,而且连接过程不需要用户参与,更不需要有任何其他软件服务和设备支持。UPnP规范是基于TCP/IP协议,针对设备彼此间通信而开发和定制的高层协议。UPnP最大的愿景就是希望任何设备一旦接入网络,所有在该网络上的设备马上就能知道新设备加入,这些设备彼此之间能互相沟通,在不需要任何设置的情况下,可以直接使用

或控制设备,体现完全的即插即用特性。UPnP技术使用标准的、不依赖于特定的设备驱动程序。UPnP设备可以自动配置网络地址,宣告它们在某个局域网子网的存在性,以及互相交换双方的设备描述信息和服务描述信息。UPnP也推动了因特网技术的发展,包括IP、TCP、UDP、HTTP、SSDP和XML等技术。该协议是说明性的,利用XML进行表述和HTTP进行传输。这也是UPnP被称为通用即插即用的原因所在。


14.2UPnP架构
-----------------------------------------------------------

14.2.1UPnP协议术语
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1.UUID
通用唯一识别码(UniversallyUniqueIdentifier),用来区别局域网、分布式系统中
的不同设备终端,让它们有唯一的被识别的标识,其格式为xxxxxxxx-xxxx-xxxxxxxxxxxxxxxxxxxx,分别表示当前日期(8)-时间(4)-时钟序列(4)-全局唯一的IEEE
机器识别号(16)。在有物理网卡的情况下,机器识别码就是物理网卡MAC地址,如果没
有物理网卡则以其他方式获得,但是要全局唯一。
2.UDN
单一设备名(UniqueDeviceName,UDN),基于UUID,用来标识一个设备。在不同
的时间,对于同一个设备UDN是唯一的。
3.URI
Web上可用的各种资源,比如文档、图像、视频片段、语音和图片等,由一个通用资
源标识符(UniversalResourceIdentifier,URI)进行定位。URI一般由3个部分组成:访问
资源的命名机制、存放资源的主机名和资源自身的名称,使用路径表示。例如下面的URI,
它表示了当前的HTML4.0规范:http://www.domain.com.cn/html/html40/。它表示一个可
通过HTTP协议访问的资源,资源位于主机www.domain.com.cn上,通过路径
“/html/html40”访问。
4.URL
统一资源定位符是因特网上用来描述信息资源的字符串,主要用在各种因特网客户程
序和服务器程序上。采用URL可以用一种统一的格式来描述各种信息资源,包括文件、
服务器的地址和目录等。
5.URN
统一资源名称用来唯一标识一个实体,但是无法给出实体的具体位置。它用于标识持
久性的因特网资源。URN可以提供一种机制,用于查找和检索定义特定命名空间的文件。
尽管普通的URL可以提供类似的功能,但是在这方面,URN更加强大并且更容易管理,
因为URN可以引用多个URL。

14.2.2 UPnP组件
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

UPnP服务系统是由支持UPnP的网络和符合UPnP规范的设备共同构成,整个系统
由设备(Device)、服务(Service)和控制点(ControlPoint)3个部分所构成。
1.设备
这里的设备是指符合UPnP协议规范的设备。一个UPnP设备可以看成一个包含服务并
嵌套了常规设备和服务的容器。例如,一个具有UPnP功能的路由器设备可以包含IP层数据
包转发服务、服务质量(QualityofService,QoS)服务等。也就是说,UPnP设备不能仅仅
理解为硬件意义上的设备,而应当包括服务功能。不同种类的UPnP设备将关联不同的设置、
服务和嵌入设备以及嵌入服务。如路由设备和交换设备,它们的服务就不可能定义成一样的。
2.服务
设备执行用户请求的过程,根据请求目的和业务的不同,可划分成不同的业务单位,
每个单位就称为一个服务。每一个服务,对外都表现为具体的行为和模式,而行为和模式
又可以用状态和变量值进行描述。一个设备也可以被定义多个服务。不论是设备的定义信
息还是服务的描述信息,都保存在一个XML文件中,这个文件也是UPnP协议构成的一
部分。当设备建立和使用服务的时候,XML文件可以与它们进行关联。XML文件中还有
一个很关键的状态表,状态表可进一步分为“服务状态表”和“事件状态表”。在整个UPnP
设备运行的全过程中,状态表贯穿始终,当设备状态改变的时候,例如发生参数变化或状
态刷新的时候,立即就在“状态表”中反映出来。如控制服务器在接收到设置时间的行为
14.3UPnP协议267
请求时,就立即执行请求并给出响应,同时更新状态表中的有关状态数据。相应地,事件
服务器负责向对此事件感兴趣的设备公布所发生的状态改变。例如,当办公区域温度达到
一定值后,事件服务器产生相应温度超标事件并向温度报警器发送温度超标报警,以便及
时处理,恢复温度正常。
3.控制点
在UPnP网络中,用户请求设备执行的控制全部是通过控制点实现的,控制点首先是
一个有能力控制别的设备的控制者,还要具有在网络中“发现”控制目标的能力。在发现
控制目标之后,控制点应当作出如下反馈:
●取得设备的描述信息并得到所关联的服务列表。
●取得相关服务的描述。
●调用控制服务行为。
●确定服务的事件“源”,不论何时,只要服务状态发生改变,事件服务器会立即向
控制点发送一个事件信息。

14.3 UPnP协议
-----------------------------------------------------------

UPnP协议栈图示如图14-1所示。
UPnPvendor
UPnPforum
UPnPDeviceArchitecture
SSDPSOAPGNEA
HTTPUHTTPMUHTTPHTTP
UDPTCP
IP
图14-1UPnP协议栈图示

UPnP是一个多层协议构成的框架体系,每一层都以相邻的下层为基础,同时又是相邻上层的基础,直至达到应用层为止。该图的最下面是就是IP和TCP这两层,负责设备的网络层地址服务以及可达性,TCP用来建立传输层的服务。第三层是HTTP、HTTPU和HTTPMU层,这一层属于传输协议层。传输的内容都是
经过“封装”后,存放在特定的XML文件中的。对应的SSDP、GENA、SOAP指的是保存在XML文件中的数据格式。到这一层,已经解决了UPnP设备的IP地址和传输信息问题。第四层是UPnP设备体系定义,仅仅是一个抽象的、公用的设备模型。任何UPnP设备都必须使用这一层。第五层是UPnP论坛的各个专业委员会的设备定义层。在这个论坛中,不同电器设备由不同的专业委员会定义,例如,电视委员会只负责定义网络电视设备部分,空调器委员会只负责定义网络空调设备部分,依此类推。所有的不同类型的设备都被定义成一个专门的架构或者模板,供建立设备的时候使用。进入这一层,设备已经被指定了明确用途。当然,这些都必须遵守标准化的规范。从目前看,UPnP已经可以支持大部分的设备,从计算机、计算机外设、移动设备到家用消费类电子设备等,无所不包,随着这个体系的普及,将可能有更多的厂家承认这一标准,最终,可能演变为公认的行业标准。处于UPnP协议最顶端的是应用层,它是由UPnP设备制造厂商定义的部分。包括设备、服务相关的描述信息,应用层的信息由设备制造厂商来提供,这部分一般有设备厂商提供的、对设备控制和操作的底层代码等。

14.4 UPnP工作流程
-----------------------------------------------------------

14.4.1寻址
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在因特网上的每个设备都有唯一的地址标识,UPnP设备也不例外。地址是整个UPnP
系统工作的基础条件,每个设备都应当是动态主机配置协议的客户端。当设备首次与网络
建立连接后,利用DHCP服务,使设备得到一个IP地址。这个IP地址可以是DHCP系统
指定的,也可以是由设备选择的。当局域网内没有提供DHCP服务时,UPnP设备按照协

议规定会从169.254.0.0/16地址范围获取一个局域网内唯一的IP地址。设备还可以使用域
名,这就需要域名解析服务来处理和转换域名和IP地址的对应关系。

14.4.2发现
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

●有控制请求,在当前的网络中查找有无对应的可用设备。
●某一设备接入网络、取得IP地址之后,就开始向网络“广播”自己已经进入网络,
即寻找控制请求。
UPnP发现设备用到的协议是简单服务发现协议(SimpleServiceDiscoveryProtocol,
SSDP),说明设备是怎样向网络通知或者撤销自己可以提供的服务,控制点(Control
Pointer)是如何搜索设备以及设备是如何回应搜索的。
SSDP格式套用HTTP1.1的部分消息头字段,但是和HTTP不同,SSDP是采用UDP
传输的,而且SSDP没有消息体,就是说SSDP只有信头而没有信件内容。SSDP第一个要
填充的字段是起始行,说明这是个什么类型的消息。比如填“NOTIFY*HTTP/1.1/r/n”,
就说明这个SSDP消息是个通知消息,一般设备加入网络或者离开网络都要通知,更新自
己的服务后也要通知一下。别的设备看见这个消息的起始行就知道有设备状态变了,自己
就打开这个消息看一下有没有需要更新的。如果填“NOTIFY*HTTP/1.1/r/n”,就要填
LOCATION字段,填一个描述URL,控制点可以通过这个地址来取得设备的详细信息。
填“M-SEARCH*HTTP/1.1/r/n”就是要搜索了;响应别人的搜索就填“HTTP/1.1200
OK/r/n”。
SSDP第二个要填充的字段是目的地址HOST。比如填上“HOST:239.255.255.250:1900”,
就是组播(multicast)搜索,这里239.255.255.250是组播地址,就是说这条消息会发给网
络里面该组地址的设备,1900是SSDP协议的端口号。如果HOST地址是特定地址,那这
就是单播(unicast)。响应不填这个字段,它会在ST字段里面填响应地址(responeaddress),
就是发来搜索信息的设备地址,响应消息的话还会发送一个包含自己地址URL的字段。
响应的意思就是跟发现者说:我好像是你要找的人,我的地址是XXXX,详细情况请联系
我。响应以UDP单播的形式进行。

14.4.3描述
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

控制点想要得到一个符合UPnP规范的设备的更详细信息时,就需要向这个设备发布的统一资源定位符来要。返回来的东西一般是扩展性标记语言(ExtensibleMarkup Language,XML),描述分为两部分:一个是设备描述,是UPnP设备的物理描述,就是说
这个设备是什么;另一个是这个设备提供的服务列表以及服务描述,就是设备对应的服务描述了,就是设备可以提供哪些服务。这些设备和设备提供的服务的描述格式也是有要求的,开发商也可以自定义,只要符合UPnPForum的规范。比如一个路由器设备,有三层转发、点对点功能和QoS功能,那么这个路由器设备就是一个根设备(rootdevice),它下属有三层转发、点对点功能和QoS功能这些从设备。路由器的设备描述XML中会有一个设备列表,列出三层转发、点对点功能、QoS这些子设备的基本信息及这些设备描述的URL,以及设备的呈现URL,这个URL在本地会加载一个网页,在这个网页上可以操作设备及其他拥有的服务。还会有一个服务列表,里面列出路由器设备可调用的服务基本信息及服务描述URL。服务通过访问服务描述URL可以取得服务描述XML,里面会详细介绍服务的信息,包括干什么用的,属于哪个设备,有哪些功能,每个功能调用都需要哪些参数,以及如何调用此OpenWrt-IGD功能等。

14.4.4控制
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在UPnP设备描述部分,设备描述信息里还有关于如何控制设备的描述,有一个控制URL,这个URL用来告诉控制点可以向这个URL发送不同的控制消息以便用来控制这个设备,当控制点向设备发出控制时,设备会返回一个信息反馈。这种控制点和设备之间的沟通信息按照简单对象访问协议(SOAP)的格式来写。SOAP通过HTTP来传,现在的版本是1.1,叫作SOAP1.1UPnP描述文件。这个描述把控制/反馈信息分成3种,分别是UPnP控制请求、UPnP控制响应和UPnP控制错误响应。SOAP协议有消息头和消息体,消息里面就可以写功能调用了。这里可能还需要传参数,比如想播放一个视频,要把视频的URL传过去,设备收到后要给予响应,表示能不能执行调用,出错的话会返回一个错误代码。

14.4.5 事件
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
在服务进行的整个时间内,只要变量值发生了变化或者模式的状态发生了改变,就产生了一个事件,该事件的服务提供者(某设备的某个服务)会把该事件向整个网络进行多播。而且,控制点也可以事先向事件服务器订阅事件信息,就像RSS订阅一样,保证将该控制点感兴趣的事件及时准确地单播传送过来。

订阅事件通常是控制点向发布者发送订阅消息,控制点也可以向消息发布者发送更新订阅消息、退订消息等请求。消息发布者向消息订阅者推送订阅。事件的订阅和推送这块用的通信协议是通用事件通知框架(GeneralEventNotificationArchitecture,GENA),通过HTTP/TCP/IP传送。GENA的格式详细请参阅UPnP-arch-DeviceArchitecture-v1.1,下面列出订阅过程供参考。
(1)订阅。发布者发送订阅消息主要包含事件URL和服务标识ID号,这两个可以在设备服务描述信息中找到,以及寄送地址。还会包含一个订阅期限。
(2)成功订阅。发布者收到订阅信息,如果同意订阅的话就会为每个新发布者生成一个唯一的发布者标识并记录发布者的有效时间。还会记录一个顺序增长事件关键字用来保证事件确实推送到订阅者那里。比如说有个新事件,关键字是6,然后把这个事件推送给某个订阅者那里,订阅者那里记录的事件关键字是4,现在收到的事件关键字是6,他就知道他没收到关键字为5的事件,这样他就向发布者索要漏收的事件,从而保证双方变量值或状态的一致。
(3)首次推送。订阅者同意订阅之后还会向发布者发送一组初始变量或状态值,进行首次同步。
(4)续订。订阅者必须在订阅到期前发送续订请求进行消息续订。
(5)订阅到期。订阅到期后发布者会把订阅者的信息删除,订阅者又回到订阅前的状态。
(6)退订。订阅者发送取消订阅信息将会取消订阅。订阅者因非正常退出网络的话,则不会退订直到订阅到期。
(7)订阅操作失败信息。当订阅、续订和退订不能被发布者接收或者出现错误时,发布者会发送一个错误代码。
关于多播/组播和单播。事件的组播采用UDP/IP,它和SSDP一样,就是端口号变成了7900。图14-1所示的是几个协议的所处层的位置,可以清楚地看到它们之间的差别。
首先关于IP多播,由于TCP只适用于一对一的通信,所以只存在UDP多播,多播的重点
是提高网络效率,将同一数据包发送给尽可能多的可能未知的计算机。像这种对网内所有
设备的频繁消息通知采用多播是为了减小网络负担。SSDP也是一样,但是SSDP和多播这
种采用UDP方式的协议存在一个问题,就是可靠性不够。解决的办法就是多次通知,但
是一般不会超过3次,以免增加网络负担,否则就得不偿失了。像SSDP的话会采用定期

广播宣告的方式,使用各种各样原因而没收到宣告的控制点重新获得设备宣告信息,同时
也解决了UDP丢包的问题。前面在寻址的时候用到的DHCP用的是UDP广播。当一个新
的设备加入网络时,它想要得到一个个IP,但又不知道DHCP服务器的IP地址,所以它
就在网内广播,用255.255.255.255地址来通知所有计算机。DHCP服务器收到请求后会为
它申请并返回一个IP地址。

14.4.6表达
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

只要得到了设备的URL,就可以取得该设备表达的URL,取得该设备表达的HTML,然后可以将此HTML纳入控制点的本地浏览器上。这部分还包括与用户对话的界面,以及与用户进行会话的处理。因此设备表达可以理解成遥控器。这部分定义描述界面、规范界面以及传输界面内容。远程界面是供控制点用户使用的,控制点用户通过远程界面完成设备描述的获取、控制设备、订阅收取设备事件等。

14.5 UPnP应用之IGD
-----------------------------------------------------------

14.5.1 IGD框架
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

家庭路由器是一个家庭局域网和互联网之间的网络互联设备,路由器作为专门独立的设备实现一组UPnP设备和对家庭网PC提供服务。通常这个服务模型也针对小型企业网络。通常这些服务仅针对家庭网内的设备开放,在家庭网外通常不允许使用这些服务。图14-2所示的是因特网网关设备(InternetGatewayDevice,IGD)在网络中的部署结构。控制点和UPnP设备进行通信并控制UPnP设备和服务,是用户请求和设备、服务之间的桥梁。控制点可以发起对设备和服务的查询,从而得到设备和服务的属性。。LAN设备是路由器上一个物理局域网接口的虚拟LAN设备,家庭局域网通向互联网的入口,和WAN设备共同组成了因特网网关设备,是家庭内部侧的网络接口,所有关于因特网的业务请求都必须首先经过LAN设备向WAN设备进行转发,请求对应的响应也必须最后到达LAN设备。

图14-2IGD网络结构
WAN设备是路由器上一个物理接口的虚拟WAN接口设备,互联网的对外接口,具有物理接口的任何属性配置,一个WAN设备至少以一种方式连接到互联网。IGD设备和服务结构如图14-3所示。
图14-3IGD设备和服务结构WAN连接服务提供WAN口连接互联网的服务,连接方式可以为IP或者PPP方式。对于不同的连接方式,有相应的连接属性和管理方式。比如IP连接,具备IP三层接口的IP地址、掩码等属性。

WANIPv6防火墙提供IPv6防火墙的相关配置、设备的接入规则、数据的转发策略等服务。LAN主机配置管理提供局域网主机配置管理服务、局域网工作的网段地址、局域网提供的动态地址配置协议的IP地址池、地址有效期等配置。

14.5.2 端口映射在IGD中的应用
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

计算机提供的服务是以TCP/IP协议族的传输层端口进行区别的,例如Web服务使用80端口、FTP服务使用21端口等。当IGD的局域网设备访问同一台服务器的不同端口服务时,就需要设置端口映射。根据方向的不同可以分为局域网到广域网和广域网到局域网的端口映射。当路由器同时有多个WAN口服务,每个WAN口具有不同属性的服务,这些服务可以体现在不同的运营商,需要根据不同的家庭局域网客户请求来选择对应与此局域网客户端的互联网接口服务。使用地址映射功能可以将家庭局域网内的某个客户端的请求转到指定的WAN口服务接口,并使用该WAN口服务进行数据处理。当在局域网内提供某种Web服务,并想让广域网的用户可以访问自己局域网的Web服务时,可以建立广域网到局域网的端口映射。这种情况下,广域网的用户通过访问自己的公网IP服务时,就相当于访问了自己局域网的Web服务。IGD设置端口映射示意图、IGD设置端口映射流程分别如图14-4和图14-5所示。设置端口映射参数描述则见表14-1。设备IGD主机
第1步
调用Addportmapping
InternalClient=192.168.1.11
InternalPort=3000
ExternalPort=1000
RemoteHost=11.12.13.14
Protocol=UDP
设备IP:192.168.1.11WANIP:22.23.24.25主机IP:11.12.13.14
第2步
创建NAT规则
192.168.1.11:3000<->22.23.24.25:1000
目的IP为11.12.13.14
第3步
发送报文到目的地11.12.13.14
源IP:192.168.1.11
源端口:3000
目的IP:11.12.13.14
目的端口:6000
第4步
经过IGD后,报文被修改为
源IP:22.23.24.25
源端口:1000
目的IP:11.12.13.14
目的端口:6000
图14-4IGD设置端口映射示意图

表14-1设置端口映射参数描述
参数含义
NewRemoteHost要访问的目的IP地址
NewExternalPort数据包从设备出去时使用的端口
NewProtocol数据包匹配的协议类型
NewInternalPort数据包进入设备时使用的端口
NewInternalClient数据包进入设备时的源IP地址
NewEnabled此映射是否被启用
NewPortMappingDescription此端口映射描述
NewLeaseDuration映射生效时间
NewLeaseDuration取值为1~604800秒
如果NewLeaseDuration为0,那么默认按照604800处理
NewExternalPort和NewInternalPort大于等于1024
NewInternalClient是控制点(CP)的IP地址
控制点2IGD设备
设备宣告(广播)
设备/服务搜索(广播)
控制点1
设备宣告(广播)
向设备发送增加端口映射操作
设备/服务搜索响应(单播)
增加端口映射操作响应
图14-5IGD设置端口映射流程图
(1)设备宣告。UPnP设备向本网络广播地址239.255.255.250的1900端口广播自己的
属性:
NOTIFY*HTTP/1.1HOST:239.255.255.250:1900
CACHE-CONTROL:max-age=10
LOCATION:http://IPADDRESS:PORT/.xml
NT:urn:schemas-UPnP-org:device:InternetGatewayDevice:1
NTS:ssdp:alive
SERVER:OS/1.0UPnP/1.0product/1.1
USN:uuid:设备UUID
(2)设备发现。控制点向本网络广播地址239.255.255.250的1900端口广播自己搜索
的设备或者服务属性,由控制点发起设备搜索动作:
SEARCH*HTTP/1.1
HOST:239.255.255.250:1900
MAN:"ssdp:discover"
MX:6
ST:urn:schemas-UPnP-org:service:WANIPConnection:1
(3)设备发现响应。设备对控制点发出发现请求的响应:
HTTP/1.1200OK
CACHE-CONTROL:max-age=7200响应有效期
LOCATION:http://192.168.0.1:8081/IGDdescription.xml设备描述文件路径
SERVER:OS/1.0UPnP/1.0product/1.1
ST:WANIPConnection搜索目标
NTS:ssdp:alive
USN:设备UUID
(4)获取设备描述文件。控制点向http://192.168.0.1:8081/IGDdescription.xml发起获取
设备描述文件请求并得到设备描述文件内容。
(5)解析设备描述文件。控制点解析IGDdescription.xml文件,解析到WANDevice设
备、WANConnection子设备以及WANIPConnection服务。
(6)添加端口映射请求。控制点向WANIPConnection服务发送AddPortMapping动作,
用来添加端口映射,所需参数见表14-1。