13.OpenWrt-UCI防火墙
===========================================================

如果直接使用iptables命令,不便于管理。OpenWrt采用UCI配置来管理防火墙规则,这样将便于用户使用命令或Web接口来管理。另外加入UCI配置层可以分离路由器控制层和转发层。

13.1概述
-----------------------------------------------------------

OpenWrt使用Netfilter来实现报文过滤、网络地址转换和报文修改。UCI防火墙封装了Netfilter的配置接口,抽象了防火墙系统特征来提供简单的配置模型,适合大多数场景。UCI配置还提供了扩展接口,用户自己需要特殊iptables命令时也可直接配置。防火墙的核心是防火墙规则,所有的规则在一起就是规则集。这些规则允许或拒绝某些主机去访问另外一个网络的主机。通过组合这些规则,就可以创建非常复杂的强大规则集。但是手动维护这些规则集将非常困难,因此OpenWrt定义了安全域(Zone)的概念,可以减少管理的负担。
UCI防火墙映射一个或多个接口在一起为一个安全域,这样可以简化配置模型。安全域是一个相同规则的区域,一个安全域根据接口来划分,可以包含一个或多个接口。可以同时定义多个接口的默认规则,以及接口之间的转发规则,还有前两步未覆盖到的其他规则。安全域也用于配置网络地址转换、端口转发规则、重定向等。
安全域必须映射到一个或多个接口,并最终映射到多个物理接口设备,因此安全域不能用于指定子网和按照iptables规则来操作物理设备接口。当接口的子网包含另外一个网关时,可以用来达到目的地不属于自己的子网网络。通常转发是在局域网和广域网之间的接口完成,因此使用路由器作为局域网和因特网之间的边缘网关。UCI的防火墙默认配置提供了这样的一个共同设置。典型智能路由器设置为两个安全域,wan-连接互联网,lan-连接局域网。
Netfilter系统是数据包通过各个规则的链式处理过滤器。第一个规则如果没有匹配,则继续下一个规则匹配,直到数据报文命中ACCEPT、DROP或REJECT之一。如果直到最后一个仍未匹配,默认规则最后生效,具体的规则首先起作用。OpenWrt的防火墙规则也是如此,在配置文件中,默认规则在最前面,但最后生效,同级别的规则按照配置文件顺序先后生效。

13.2防火墙配置
-----------------------------------------------------------

路由器的最小防火墙配置通常有一个缺省(defaults)部分、至少两个安全域(局域网
和广域网)和一个转发——允许数据从局域网到广域网。
这一节的内容是对防火墙配置文件中定义的配置节的详细描述。防火墙配置文件位于
/etc/config/firewall中。UCI配置文件没有区分类型,但防火墙模块解析处理过程需要区分
类型,因此配置文件的配置项需要填入指定类型的值,主要有字符串、布尔值、整型值、
MAC地址和IP地址等类型。

13.2.1Defaults
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Defaults配置节定义了不属于特定区域的全局防火墙设置。配置类型为“defaults”,表
13-1所示的是这个配置节的主要定义选项。
表13-1defaults配置节选项含义
名称类型含义描述
input字符串设置过滤表的INPUT链的策略,默认为REJECT
output字符串设置过滤表的OUTPUT链的策略,默认为REJECT

续表
名称类型含义描述
forward字符串设置过滤表的FORWARD链的策略,默认为REJECT
syn_flood布尔值启动SYN洪水攻击保护,默认不启用
disable_ipv6布尔值关闭IPv6防火墙,默认打开

13.2.2Zones-安全域
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

一个安全域根据接口来划分,可以包含一个或多个接口,在源和目的地之间进行转发、
生成规则和重定向。输出的流量伪装是每一个安全域的基础控制。注意伪装是对即将报文
离开的接口进行定义,是将报文的源IP地址转换为路由器的出口IP地址。
INPUT规则用于匹配流量从这个安全域的接口到达路由器本身,即目的地址为路由器
IP地址的流量。OUTPUT规则用于处理从路由器自己产生的报文并通过安全域的接口,
即作用于源地址为路由器地址的报文。FORWARD规则用于处理从一个安全域到另外一个
安全域的报文,即经过路由器来转发的报文。
安全域的配置节类型为“zone”,其主要选项在表13-2中有详细描述。
表13-2zone配置节选项含义
名称类型含义描述
name字符串定义安全域的名称
network链表安全域的接口列表
input字符串进入安全域报文的默认策略(ACCEPT、REJECT或DROP),默认为DROP
forward字符串转发流量的默认安全策略(ACCEPT、REJECT或DROP),默认为DROP
output字符串该安全域发出报文的默认策略(ACCEPT、REJECT或DROP),默认为DROP
masq布尔值该安全域流量是否进行地址伪装,即是否进行地址转换,典型情况下wan
域均启用该设置
mtu_fix布尔值对于所有的外出流量固定其最大分片大小值

13.2.3转发
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

转发部分控制安全域之间的数据流量,可以使MSS(最大分片大小)为特定的方向。
一个转发规则仅代表一个方向。允许两个区域之间的双向流量,这需要两个转发规则,src和
dest部分颠倒过来即可,转发配置节的类型为“forwarding”。主要选项在表13-3中描述。
表13-3forwarding配置节选项含义
名称类型描述
src安全域名称指定流量的源区域,必须指向一个已经定义的安全域的名称
dest安全域名称指定流量的目的区域,必须指向一个已经定义的安全域的名称
family字符串协议家族(ipv4、ipv6或者any),默认值为any,用于产生iptables规则
iptables规则生成该部分依靠需要连接跟踪工作来生成状态匹配。在src和dest安全域
至少需要有一个连接跟踪通过MASQ或连接跟踪选项启用。如果没有启用连接跟踪机制,那
报文只能单向通过,返回的报文将被拒绝。示例13-1表示允许局域网到广域网的报文转发。
示例13-1:
configforwarding
optionsrc'lan'
optiondest'wan'

13.2.4重定向
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

目的地址转换(DNAT)定义在重定向配置节。在指定源安全域的所有进入的报文如
果匹配给定的规则将重定向到指定的内部主机上。
重定向也叫“端口转发”或“端口映射”。端口访问可以以“start:stop”来指定,例如
8080:8090,语法和iptables类似。技术上来说,端口映射是目的地址转换的另一个术语,
报文发送到防火墙并被转换为一个新的目的地址,这个处理过程完全由防火墙自动完成。
对于设置这个规则,需要新老目的地址,并且可以选择源地址或者其他约束条件进行匹配。
重定向配置类型为“redirect”。配置选项在表13-4中详细描述。
表13-4redirect配置节选项含义
名称类型含义描述
src安全域名称指定流量的源安全域。必须指向已经定义的区域,典型的端口转
发通常是wan
src_ipIP地址匹配从指定源IP地址的报文

续表
名称类型含义描述
src_dipIP地址对于DNAT来说,匹配指定目的地址的报文;对SNAT来说,重
写源地址为指定的地址
src_macMAC地址对于流入报文,匹配指定的MAC地址
src_port端口号匹配指定源端口或范围的流入报文
src_dport端口号报文的原始目标端口
proto协议名称或数字匹配指定的协议
dest安全域名称指出流量的目的安全域,必须是一个已定义的安全域的名称。对于
DNAT这个必须为lan域
dest_ipIP地址对于DNAT,将重定向到指定的内部主机,对于SNAT,匹配给定
地址的流量
dest_port端口号或范围对于DNAT来说,重定向匹配的报文到内部主机的指定端口。对
于SNAT来说,匹配的报文将直接重定向到指定的端口
示例13-2将转发从wan接口的HTTP请求报文到IP地址为192.168.1.100、端口为80
的Web服务器上,没有指定转换后端口号,那就是目的端口不变。
示例13-2:
config redirect
option src wan
option src_dport 80
option proto tcp
option dest lan
option dest_ip 192.168.1.100

13.2.5规则
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

规则(rule)用于定义基本的接受或拒绝规则来允许或限制你访问指定主机或端口。
真正的防火墙规则在这里进行设置。规则定义如下。
- 如果src和dest均指定,规则作用于转发流量。
- 如果仅指定了src,规则匹配流入本机的流量,即目的地址为防火墙的报文。
- 如果仅指定了dest,规则匹配本机作为源地址的流量。
- 如果src和dest均没有给出,则默认作用于本机作为源地址的流量。
端口范围使用start:stop,例如8080:8090。这和iptables的语法完全一致。规则的配置
类型为“rule”,防火墙规则中如果指定了时间,则需要路由器的时间准确,否则和自己的
期望将完全不同。具体的配置选项在表13-5中详细描述。
表13-5rule配置节选项含义
名称类型描述
name 字符串规则的名称
src 安全域名称指定报文的来源,必须指向一个存在的安全域的名称
src_ipIP 地址匹配指定的源IP地址
src_macMAC 地址匹配指定的源MAC地址报文,注意没有目的MAC地址匹配
src_port 端口或端口范围匹配指定的源端口或端口范围的报文。在协议号指定的情况下使用
proto
协议名称或协议
数字匹配指定的协议报文。可以是UDP、TCP、TCPUDP、ICMP、GRE、IGMP
或者ALL。或者为代表这些协议的数字协议编号,编号含义来自文件
/etc/protocols,数字零和ALL等价
dest安全域名称指定流量的目的安全域。必须是一个已经存在的安全域名称。或者是*表示任
何安全域。如果指定了表示这个规则用于转发链,否则作用于INPUT链
dest_ipIP地址匹配指定的目的IP地址报文,如果没有配置dest域,这条规则将当作
INPUT规则
dest_port端口或端口范围匹配给定的目的端口或端口范围
target字符串匹配报文之后的行为(ACCEPT、REJECT、DROP、MARK或NOTRACK)
weekdays星期列表可以指定周一到周日的任何一天,可以组合起来,中间用空格隔开,例
如:montuewedthufri
默认的防火墙配置是接受所有的局域网流量,但是阻断所有的WAN入口主动流量,
除了当前NAT或连接的被动流量。如果要打开服务的端口,可以像示例13-3一样增加规
则。示例13-3配置将允许互联网上的主机通过SSH协议访问路由器。
示例13-3:
config rule
option src wan
option dest_port 22
option target ACCEPT
option proto tcp

示例13-4用于阻止局域网主机到广域网主机121.42.62.172的全部连接。源主机将
收到目标端口不可达的ICMP消息。这就是把这个IP地址加入了访问黑名单,不允许
访问。
示例13-4:
config rule
option src lan
option dest wan
option dest_ip 121.42.62.172
option target REJECT
示例13-5用于创建一个输出规则,阻止从路由器pingIP为8.8.8.8的主机。这个规则
没有src字段,因此仅匹配从路由器发出的报文。
示例13-5:
config rule
option dest wan
option dest_ip 8.8.8.8
option proto icmp
option target REJECT
示例13-6用于限制从局域网到广域网的目的端口为1024~65535的报文转发。
示例13-6:
config rule
option src lan
option dest wan
option dest_port1024-65535
option proto tcpudp
option target REJECT

13.2.6include
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

include用于包含自定义的防火墙规则。在防火墙配置中可以指定一条或多条include

配置节。类型为“include”,仅有一个必须的参数是包含的文件路径,所有的可选参数如
表13-6所示。
表13-6include配置节选项含义
名称类型描述
path文件名指定自定义规则的路径,默认值为/etc/firewall.user
enabled布尔值为1表示启用,为0表示不使用,即可以不用删除规则定义,就可
以这条规则不起作用,默认为启用
type字符串指定include的类型,“script”表示是传统的shell脚本,“restore”
表示是iptables-restore格式的文本
family字符串指定这个包含规则的IP地址家族(IPv4、IPv6或者any)
reload布尔值
指定规则在重新加载时是否需要被再次调用,这仅在注入到内部
规则时需要再次调用,因为内部防火墙规则链先被删除,然后再
次创建
包括类型的脚本可以包含任意的命令,例如高级的iptables规则或流量整形所需的tc
命令。由于自定义iptables规则要比一般的更具体,所以必须确保使用“-I”来插入而不是
一个“-A”来附加到最后,这样自定义规则将出现在默认规则的前面。

13.3常见用法
-----------------------------------------------------------

13.3.1MAC地址黑白名单
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MAC地址过滤是家用路由器的一个常见功能,它可以防止未授权的MAC地址访问路
由器和通过路由器访问网络。例如网络上有恶意用户,可以通过MAC地址限制指定恶意
用户主机连接到路由器,即使他拥有路由器的密码。
OpenWrt没有单独的MAC接入控制模块,但可以通过设置防火墙规则来实现。MAC
地址是计算机网卡的物理地址,它就像是网卡的身份证,在网络中进行通信时对网卡的
识别都是通过这个地址进行的。通常一个计算机仅有一个网卡,那这个网卡就可以代表
这个计算机,限制这个MAC地址即可控制计算机能否接入网络,从而有效控制了网络用户的上网权限。通常有两种方式来控制:白名单和黑名单。
(1)黑名单是指在名单内的设备不能接入网络。例如小孩的计算机不能访问。
(2)白名单是指名单内的设备可以接入网络,其他设备均不能访问。

config rule
option src lan
option dest wan
option src_mac 08:00:27:00:58:AA
option target DROP
config rule
option src lan
option src_mac 08:00:27:00:58:AA
option target DROP

示例13-7用于阻止指定客户端连接到因特网,第一个规则禁止黑名单访问网络,
第二个规则阻止从客户端连接路由器。这样该机器就不能通过该OpenWrt路由器访问
任何资源。
如果以自定义规则来实现黑名单,则使用如下4条规则进行设置:
iptables-N MAC_FILTER
iptables-I INPUT-jMAC_FILTER
iptables-I FORWARD-jMAC_FILTER
iptables-A MAC_FILTER-mmac--mac-source08:00:27:00:58:AA-jDROP

第一行首先定义了自定义链MAC_FILTER,然后紧接着将IPNUT链的报文转到MAC_FILTER,由它将匹配目标地址为路由器IP的报文。第三行规则将FORWARD链转到MAC_FILTER自定义链中,这个将匹配经过路由器转发的流量。最后一个规则将源MAC地址的规则加入到MAC_FILTER链中。通常防火墙是默认允许局域网报文通过的,因此可以仅设置拒绝通过的MAC即可。

例如,某企业想要保证仅授权用户可以连接Wi-Fi。因为通常Wi-Fi的连接密码只有一个,如果多个人访问,经常会导致密码透露给非授权用户。白名单技术就在这时派上用场,将授权用户的MAC地址增加到防火墙中,这样即使Wi-Fi连接密码泄露,非授权用户也不能通过无线路由器访问网络。如果要设置白名单模式,则需要在规则的最后增加一
个默认拒绝规则。

13.3.2家长控制
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

OpenWrt没有专门的家长控制模块,我们可以在防火墙功能中实现设置。例如,
禁止小孩在周一到周五上网,通过设置小孩专用的计算机MAC来禁止访问任何网络。
示例13-8用于禁止指定MAC周一到周五将报文转发到互联网,weekdays用来表示一
周中的第几天。

config rule
option src lan
option dest wan
option src_mac 28:D2:44:15:D5:A4
option weekdays 'mon tue wed thu fri'
option target REJECT

在企业也是同样的情况,有些公司在工作的时间会禁止使用互联网,或者是根据公司管理策略仅能访问一些授权的网站。这些策略最难的部分在于管理政策中哪些允许哪些不允许,这通常很难做出决定。在技术上使用防火墙来实现,UCI配置只能从IP层进行限制,因此如果限制访问域名,需要转换为IP地址。

config rule
option srclan
option destwan
option src_mac28:D2:44:15:D5:A4
option targetACCEPT
config rule
option src lan
option destwan
option src_ip192.168.1.0/24
option start_time9:00
option stop_time18:00
option weekdays'montuewedthufri'
optiontarget REJECT
示例13-9所示的配置实现了周一到周五的工作时间内禁止局域网用户访问网络,并允
许来自你自己MAC主机的网络访问。

13.4防火墙管理及调试
-----------------------------------------------------------

13.4.1管理防火墙
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

OpenWrt12.09的防火墙模块脚本目录为/lib/firewall,管理脚本为/bin/fw:

/sbin/fw -help
/sbin/fw <command> <family> <table> <chain> <target> { <rules> }

在配置修改之后,通过执行/etc/init.d/firewall restart生效;
调用/etc/init.d/firewall stop将删除所有自定义的规则,并设置所有标准的规则链为接受(ACCEPT)。
手动启动防火墙执行/etc/init.d/firewall start。
(1)永久停用防火墙。防火墙可以通过执行/etc/init.d/firewall disable永久禁用,需要
重启生效。注意:禁用不会删除已生效的规则。使用enable可重新激活使用防火墙。
(2)停用防火墙。运行/etc/init.d/firewall stop以删除所有规则和设置默认策略为接受。
重启防火墙,运行/etc/init.d/firewall start。
(3)删除规则。如果你增加了一个错误的规则,你可以通过以下方式删除。首先,错误的命令规则可以通过以下命令找出索引:
iptables-L-traw--line-numbers
现在进行删除。例如删除OUTPUT链的第三条规则,可执行以下命令:
iptables-traw-DOUTPUT3
(4)调试产生的规则集。观察通过防火墙程序产生的iptables命令是非常有用的,跟踪防火墙重启的iptables错误,或者验证特定UCI配置规则的结果及作用。为了看到执行过程中的规则,运行fw命令之前将FW_TRACE环境变量设置为1。FW_TRACE变量使用在/lib/firewall/fw.sh中,判断是否定义,如果已经定义,将输出执行
的每条规则:
FW_TRACE=1fwreload
将执行输出重定向到一个文件中供以后分析,使用以下命令:
FW_TRACE=1fwreload2>/tmp/iptables.log
在OpenWrt15.05版本中防火墙使用C语言来重新实现,编译安装后为fw3,使用“-d”
选项来进行输出iptables命令。还有另外一个命令也支持输出防火墙规则:
fw3print

13.4.2测试防火墙
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

防火墙规则配置越多,它就越复杂。在正式使用之前,首先需要对配置进行测试。
在配置修改完成后,需要调用以下命令来重启防火墙:
/etc/init.d/firewall restart
对于目标进行测试可以有非常方便的目标地址测试,但是如果有黑名单或者时间控制,就比较麻烦。测试时间需要你改变路由器系统时间进行测试,或者等待足够长的时间。
对于网络是否正常,可以使用ping命令进行进行测试。
对于端口是否开放,可以用NetCat工具进行验证,NetCat请参考在“测试工具”中描述的技术。

13.5名词解释
-----------------------------------------------------------

- 安全域,是指相同安全等级的区域,由一个或多个接口组成,通常具有相同防火墙规则。
- 黑名单,是指不能通过的用户名单,名单以外的用户都能通过。
- 白名单,是指能通过的用户名单,名单之外的用户都不能通过。
- 家长控制,是指家长限制孩子使用计算机网络的时间以及仅能访问限定的网络资源。