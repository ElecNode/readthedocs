11.OpenWrt-DNS与DHCP
===========================================================

域名系统(DomainNameSystem,DNS)是因特网的一项基础服务。它作为将域名和IP地址相互映射的一个分布式数据库,能够使人通过域名来更方便地访问互联网中的主机。动态主机配置协议(DynamicHostConfigurationProtocol,DHCP)是局域网的基础服务,DHCP是一种动态地向网络终端主机提供配置参数的协议,能够简化网络的管理。本章首先讲述了DNS的由来以及DNS基础知识;接着讲述了DHCP基础知识,并介绍了实现DNS代理和DHCP服务器的dnsmasq软件;最后讲述了动态域名更新系统和DNS测试工具的使用。

11.1 主机系统
-----------------------------------------------------------

在主流的操作系统上,均有一个hosts的配置文件,这个配置文件的主要作用是定义
IP地址和主机名的映射关系,这个配置可以使用文本编辑器打开并进行编辑。在微软视窗
操作系统的位置为C:\Windows\System32\Drivers\etc\hosts,当用户在浏览器中输入所想访
问的网址时,系统首先从这个hosts文件中查找域名的IP地址,如果找到就打开IP地址
的网页,如果没有找到就向DNS服务器进行查询。
在Linux系统,主机配置文件为/etc/hosts,这是主机名的静态查找表。这个文件是简
单的文本文件,用于保存主机名称和IP之间对应关系。其格式为一个IP地址占用一行,
每一个主机关联一个IP地址。格式如下所示:
127.0.0.1localhost[aliases...]
各个域之间用空格或制表字符分开。以“#”开头的文本行为注释行,不做处理。现在主流的现代操作系统中,主机系统表已经很少使用,已经被域名查找机制DNS取代,
但它仍广泛地使用在以下5个场景。
(1)启动中。大多数系统都包含名称和地址为本地网络上的信息主机信息表。这是非
常有用的,因为在系统启动时DNS解析库还没有装载到内存中。举例如下:
127.0.0.1localhost
192.168.1.1bjbook.netserver
192.168.1.100openwrt.bjbook.netopenwrt
(2)DNS输入。网络信息服务站点使用主机表作为DNS服务主机数据库的输入,或
者使用主机表作为备用配置。
(3)加快域名解析,节省网络流量。hosts文件在主机上配置具有加快域名解析的作用,
对于经常访问的网站和主机,我们可以在hosts文件中配置域名和IP的对应关系。由于有
了映射关系,当我们访问域名时,可以直接从hosts文件中解析得出,而不用访问网络上
的域名服务器,不用消耗网络流量。
(4)屏蔽网站(域名重定向)。屏蔽广告网站,有很多网站带有广告,但广告和网站
本身域名不同,因此如果能屏蔽一些众所周知的广告网站域名,这样我们利用hosts把这
些广告的网站的域名映射到本机IP或非法目的IP,这样就不会看到这些广告图片了,也不
会浪费网络流量。例如:
127.0.0.1a.com
这样计算机解析域名a.com时,就解析到错误的IP,达到了屏蔽广告网站的目的。
(5)防止DNS污染和DNS劫持。DNS劫持就是攻破了DNS服务器防护,从而获得
域名解析记录的控制权,进而修改域名解析的结果。这将导致对原始域名的访问转到另外
的IP地址。
DNS污染是因为DNS查询没有任何认证机制,而且DNS查询通常采用的UDP是无
连接不可靠的协议,因此DNS的查询非常容易被篡改:通过对UDP端口53上的DNS查
询报文进行分析,一旦发现与关键词相匹配的请求则立即伪装成目标域名的解析服务器给
查询者返回虚假结果。
如果我们已知服务器的IP地址,就可以在hosts文件中设置正确的IP地址,从而避
免DNS劫持和污染。

11.2 DNS基础
-----------------------------------------------------------

主机系统适合小型网络等一些特殊的场景。在因特网中,主机地址非常庞大,并且主
机的IP地址经常改变,因此使用域名系统DNS代替主机系统。
DNS可以被视为一种用于TCP/IP应用程序的分布式数据库,它提供主机名字和IP地
址间的相互转换。这里提到的分布式是指在因特网上的单个站点不能拥有所有的信息。每
个站点(如大学中的系、校园、公司或公司的部门)保留它自己的信息数据库,并运行一
个服务器程序供因特网上的其他系统查询。

11.2.1域名结构
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

DNS是一个分层级的分布式名称对应系统,采用类似Linux目录树的层级结构,
如图11-1所示。其最顶端有一个未命名的根节点,然后其下分为好几个基本类别名称(称
为顶层域名),例如com、org、net和gov等3字符域名,还有cn、sg、jp和us等两个字
符国家地区域名。每个节点有一个至多63个字符长的标识,域名总长度则不能超过253
个字符。命名标识中不区分大写和小写。命名树上任何一个节点的域名就是将从该节点到
最高层的域名串连起来,中间使用一个点“.”分隔这些节点。例如,一个完整的域名为
www.bjbook.net。域名树中的每个节点必须有一个唯一的名称,但域名树中的不同层级节
点可使用相同的标识,只要在不同的父节点下即可。
图11-1域名组成结构

11.2.2 DNS报文格式
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

DNS采用客户机/服务器模型。DNS默认使用TCP和UDP端口53。DNS的请求和应
答封装在UDP报文中。报文内容格式如图11-2所示。
会话标识flags
问题数目(2字节)回答资源记录数(2字节)
授权资源记录数目(2字节)额外资源记录数目(2字节)
问题(可变长度)
回答资源记录(可变长度)
授权资源记录(可变长度)
附加信息资源记录(可变长度)
图11-2DNS报文格式
DNS请求报文和响应报文格式基本相同,是由固定12字节长的报头和4个长度可
变的字段组成的。报文头部的会话标识字段由客户端生成随机值填充并由服务器原样
返回。客户端通过该字段来匹配请求和响应。flags部分非常复杂,如果是请求一般为
0x0100。如果为响应,通常有两种情况:0x8182表示服务器失败;0x8180表示服务器
成功响应。
紧接着的4个2字节字段均为无符号整型数字。对于查询报文,问题数目通常是1,
而其他3项则均为0。对于应答报文,问题数目还是1,回答数至少是1。
问题部分中每个问题的格式由3部分顺序组成:查询内容、类型(Type)和类(Class)。
类型和类均为固定的两个字节长度。
查询内容长度不定,它是一个或多个标识符的序列。每个标识符以首字节的计数值来
说明随后字符串的字节长度,每个名字的最后字节为0表示结束。计数字节的值必须是0~
63的数字,因为标识符的最大长度为63。高位字节为二进制11时,用于压缩格式,指向
报文的查询字符串位置,字符串位置是从DNS报文头部开始计算的。
DNS报文中最后3个字段分别为回答字段、授权字段和附加信息字段,均采用资源记
录(ResourceRecord,RR)格式。资源记录格式内容顺序包含域名、类型、类、生存时间、
数据长度和数据6部分。如图11-3所示。

图11-3查询报文资源格式
域名是记录中资源数据对应的名字。它的格式和前面介绍的查询名字段格式相同。类
型和类与问题域内容格式相同。生存时间字段占4个字节,是客户程序保留该资源记录的
秒数,这里已转换为15分钟。资源数据长度占两个字节长度。数据部分的格式依赖于类
型字段的值,这里的资源数据是4字节的IP地址。

11.2.3 域名解析器原理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

用户程序通过解析器与名字服务器交互;用户查询和响应是C语言编程接口的入参和
返回值,用户查询一般是调用getaddrinfo函数获取IP地址,Linux操作系统通常不缓存查
询结果,每次均调用接口函数进行查询。现在域名解析器动态库已经成为Linux主机操作
系统的一部分,供给每一个进程使用。
注意,如果未配置名字服务器,解析器将默认向127.0.0.1发起查询。
图11-4所示为Linux系统的DNS解析实现原理。解析器通常对几个不同的名字服务
器进行多个查询,才能回答特定用户的查询,因此用户域名查询可能涉及对几个网络的访
问和很长的时间。
用户程序解析器
配置文件
本地主机服务器
名字服务器
图11-4LinuxDNS工作原理图

(1)解析库首先查询主机执行流程,查询hosts文件是否有对应域名配置。
(2)如果host文件没有该域名,则在resolv.conf文件中取出第一个域名服务器
地址。
(3)然后向域名服务器地址发起域名查询请求。
(4)等待查询响应。如果超时,则向下一个域名服务器发起查询。
域名解析器提供因特网域名系统(DNS)的解析C函数库。解析器配置文件名默认为
resolv.conf,包含C函数库所需的信息,域名解析时首先读取这个文件。这个文件的可读
性非常好,包含一系列的关键词,提供各种类型的解析器信息。常用的配置有nameserver、
domain和search。
(1)nameserver。用于配置名字服务器,最多可以设置3个名字服务器,每一行一个。
如果有多个名字服务器地址,解析库将按照列表顺序查询。若第一个名字服务器查询超
时,再顺序查询下面的名字服务器,直到所有的名字服务器都尝试一遍。如果没有名
字服务器地址或者这个配置文件不存在,则默认使用本机(127.0.0.1)作为名字服务器
地址。
(2)domain。可以使用相对于本地域名的短名来查询。如果域名没有配置,则返回主
机名。
(3)search。search定义域名的搜索列表,当要查询没有域名的主机时,将在由search
声明的域中分别顺序进行查找,是只有使用短名时所要附加的域名后缀。domain和search
不能共存,如果同时存在,后面出现的将覆盖前面的定义。
11.2.4域名解析实例
我们模拟各种情况来学习DNS解析器原理,包括没有配置文件、配置多个域名服务
器和配置domain的情况。
1.没有/etc/resolv.conf配置文件
解析库默认向本机(127.0.0.1)发起域名查询,因OpenWrt本身带有dnsmasq提供服
务,因此可以返回响应。图11-5所示为访问域名时的请求和响应报文。

$#pinghaosou.com
图11-5向本机发起请求报文过程
2.配置多个域名服务器地址
resolv.conf配置如下:
nameserver59.108.61.61
nameserver219.232.48.61
$#ping163.com首先向第一个服务器59.108.61.61发起查询163.com的IP地址,如果
查不到将使用下一个域名服务器来进行查询。
3.配置有domain
resolv.conf配置如示例11-1所示,这种情况下如果访问完全合格域名,则直接向域名
服务器发起查询;如果不是完全合格域名,则首先在hosts文件中进行查找,如果在hosts
文件中找不到主机名的IP地址,则再向名字服务器发起查询请求。如果是不带点的字符
串,则加上域名后缀向名字服务器发起查询请求,如果中间带有点,则认为是一个域名,
将不用加上域名后缀,直接使用该字符串向名字服务器发起请求。
示例11-1:
domainbjbook.net
nameserver8.8.8.8

(1)执行“ping163.com”命令,首先在hosts文件中查询主机163.com的IP地址,
如果查不到将直接向名字服务器查询163.com的IP地址,找到后向目的IP发起ICMP
请求。
(2)执行“pingopenwrt”命令,首先在hosts文件中查询主机openwrt的IP地址,如
果查不到将拼接域名后缀“bjbook.net”,然后向名字服务器查询openwrt.bjbook.net的IP
地址,找到后向目的IP发起ICMP请求。

11.3 DHCP基础
-----------------------------------------------------------

11.3.1 引言
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在TCP/IP网络上,每台主机在访问网络及其资源之前,都必须进行基本的网络信息
配置,包含IP地址、子网掩码、默认网关和DNS等。在大型网络中,如果每台终端主
机的地址都由不同的使用者来分配,那么就很容易出现地址相同的情况。对于经常移动
的终端,重新配置可能需要很长时间,并且容易出错,如果IP配置错误将会导致不能访
问网络。因此需要一种机制来简化主机IP地址的配置。动态主机配置协议DHCP应运
而生。
采用DHCP的好处在于减少了网络管理员和用户的负担。这将可以减少手工配置IP
地址导致的地址冲突,以及网关地址或DNS地址错误导致的不能访问网络等问题。

11.3.2 DHCP原理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

DHCP服务器拥有一个IP地址池,当任何启用DHCP的客户机连接到网络时,可
从服务器那里租借一个IP地址,不再使用的IP地址自动回收到地址池中,供再次分配
使用。
DHCP保证同一时刻的任何IP地址只能分给一个客户机使用。当DHCP客户机重新
启动时,应配置为相同的IP地址。在DHCP服务器重启的情况下,也应当给每一个客户

机分配相同的IP地址,并且和手动分配的IP地址共存。这要求DHCP服务器对已分配的
地址进行保存,并且在客户端不使用时进行回收。
DHCP是一种动态地向网络终端提供配置参数的协议。在终端提出申请之后,DHCP
服务器可以向终端提供IP地址及子网掩码、网关和DNS服务器地址等参数。
DHCP协议基于UDP协议,客户端的端口号是68,服务器的端口号是67。

11.3.3DHCP报文
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
DHCP的请求和应答封装在UDP报文中。报文内容格式如图11-6所示。
报文类型硬件类型硬件地址长度跳数
事务ID
秒数flags
客户端IP地址
你的(客户端)IP地址
服务器IP地址
中继IP地址
客户端MAC地址(16字节MAC地址后面补零)
服务器主机名(64字节)
引导文件名(128字节)
可选字段
图11-6DHCP报文格式
“报文类型”字段为1表示请求,为2表示应答。硬件类型字段为1表示以太网,以
太网的硬件地址长度为6字节。“跳数”字段由客户端设置为0,如果和DHCP服务器之
间有中继器的话将被修改。
“事务ID”字段是一个由客户端设置并由服务器返回的4字节整数。客户机使用它对
请求和应答进行匹配。对于每个请求客户端首先将该字段设置为一个随机数。客户端开始
进行DHCP请求时,将“秒数”字段设置为一个时间值。服务器能够看到这个时间值,备

用服务器在等待时间超过这个时间值后才会响应客户的请求,这意味着备用服务器接管
DHCP服务。“flags”是保留值,设置为0。
客户端IP地址字段填0,如果上次成功配置过IP地址,它将写到“客户端IP地址”
字段。服务器返回应答时将该客户的IP地址写入“你的IP地址”字段,并将自身IP地址
填写到“服务器IP地址”字段。在同一网络中继地址填0。
客户端MAC地址字段填写网卡硬件地址,不足部分填0。服务器主机名字段由服务
器来填写,通常为0。引导文件名字段用于填充TFTP下载的文件全路径,通常用于无盘
启动工作站。选项字段用于扩展,但实际上有一些选项在终端节点接入互联网时是必须的。
这些包含DNS地址、网关地址和子网掩码等。
可选字段部分均以TLV(类型-长度-值)来表示。
子网掩码选项用于指定客户端的子网掩码。子网掩码的类型码为1,长度为4字节。
路由选项指定了客户端子网的下一跳地址。如果有多个,路由器将按照优先顺序排列,
一般为路由器自身IP地址。类型码为3,长度为4的倍数。
域名服务器选项用于将名字服务器提供给客户端,并且以优先顺序给出,选项代码为
6,最小长度为4个字节,并且是4的倍数。
传输层使用UDP协议,使用两个固定的端口号,服务器使用67,客户端使用68。这
样可以非常方便地区分是请求还是响应。
IP层在请求IP地址时采用链路层广播,链路层广播地址为“FF:FF:FF:FF:FF:FF”。网
络层目的IP使用广播地址255.255.255.255,源地址采用0.0.0.0,这是因为请求时自身没有
IP地址,并且不知道服务器的IP地址。

11.3.4 DHCP工作流程
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
DHCP通常由客户端发起广播请求,服务器收到请求后在配置文件中查询,如果符合要求则向客户端提供服务。图11-7所示为DHCP配置IP地址的报文流程。
11.4dnsmasq223
10.0000000.0.0.0255.255.255.255DHCP342DHCPDiscover-
TransactionID0xba170374
20.00030410.0.2.210.0.2.15DHCP590DHCPOffer
-TransactionID0xba170374
30.0053450.0.0.0255.255.255.255DHCP342DHCPRequest-
TransactionID0xba170374
40.00551010.0.2.210.0.2.15DHCP590DHCPACK
-TransactionID0xba170374
图11-7DHCP配置IP流程
(1)客户端在以太网上广播“DHCPDiscover”报文来发现DHCP服务器。
(2)IP为10.0.2.2的服务器收到广播请求后,向客户端回应请求,发出单播“DHCP Offer”报文,并且目的IP为10.0.2.15。
(3)客户端再次以广播形式发出“DHCPRequest”报文。这是因为客户端可能收到多个服务器“DHCPOffer”报文,客户端会根据报文的内容来选择一个给予响应,采用广播形式可以让多个服务器均可收到。
(4)当服务器收到“DHCPRequest”报文后,服务器在将客户端的MAC地址同分配的IP地址绑定后,将IP信息(IP、掩码、网关地址和DNS等)发送给客户机。
(5)客户机收到“DHCPACK”报文后,将IP信息设置到主机系统上。这时IP设置就完成了,客户机就可使用IP来访问网络了。

11.4 dnsmasq
-----------------------------------------------------------

11.4.1 概述
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

智能路由器服务于家庭和小型企业网络,当多个人同时上网时,客户机经常进行DNS查询,大多查询会是重复的域名,如果有一个DNS缓存代理服务于局域网,这样将减少

DNS的因特网存取,加快DNS访问速度和节省网络流量,dnsmasq软件就是在这种情况下应运而生的。
dnsmasq是轻量级DHCP、TFTP和DNS缓存服务器,给小型网络提供DNS和DHCP服务。它的设计目标是轻量级的DNS,并且占用空间小,适用于资源受限的路由器和防火墙,以及智能手机、便携式热点设备等。dnsmasq接收DNS请求,并从本地缓存中读取,如果缓存不存在就转发到一个真正的
递归DNS服务器。它也可以读取/etc/hosts的内容,这样就可以对局域网的主机查询进行DNS查询响应,这些局域网的主机名称不会暴露在全局DNS域中。
DNS子系统提供网络的本地DNS服务器,即只服务于局域网的DNS服务器。转发所有类型的查询请求到上游递归DNS服务器,并且缓存通用记录类型(A、AAAA、CNAME和PTR)。支持的主要特性有以下几方面。
-本地DNS服务器可以通过读取/etc/hosts来定义,或者通过导入DHCP子系统的名字,或者通过各种各样的用户配置。
-上行服务器可以各种遍历的配置,包括动态配置。
-认证DNS模式允许本地DNS名称导出到全球DNS区域。dnsmasq作为这个区域的认证服务器,也可以提供区域传送。
-从上游服务器DNS响应执行DNSSEC验证,防止欺骗和缓存中毒。
-指定子域名可以继承自它们的上行DNS服务器,这样使VPN配置更容易。
-国际化域名支持等。

11.4.2配置
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

dnsmasq的配置文件位于/etc/config/dhcp,控制着DNS和DHCP服务选项。默认配
置包含一个通用的配置节来指定全局选项,还有一个或多个DHCP来定义动态主机配置
服务的网络接口和地址池等。还可以包含多个域名和主机配置,并且提供客户端地址列
表来查询。
1.全局配置
表11-1所示的是dnsmasq的所有配置选项。
11.4dnsmasq225
表11-1dnsmasq参数含义
名称转换后配置含义描述
domainneededdomain-needed不会转发针对不带点的普通文本的A或AAAA查询请求到上行的域名
服务器。如果在/etc/hosts和DHCP中没有该名称将直接返回“notfound”
cachesizecache-size指定缓存的大小。默认是150
bogusprivbogus-priv所有私有查找如果在/etc/hosts没找到,将不转发到上行DNS服务器
filterwin2kfilterwin2k不转发公共域名不能应答的请求
localise_querieslocalise-queries
如果有多个接口,则返回从查询接口来的接口网络的主机IP地址。
在同一主机有多个IP地址时非常有用,返回查询网段的IP地址,
这样源主机和目标主机通信是将不会跨越路由器
rebind_protectionstop-dns-rebind上游域名服务器带有私有IP地址范围的响应报文将被丢弃
rebind_localhostrebind-localhost-ok允许上游域名服务器的127.0.0.0/8响应,这是采用DNS黑名单时所
需的服务,这在绑定保护启用时使用
expandhostsexpand-hosts在/etc/hosts中的名称增加本地域名部分
nonegcacheno-negcache
在通常情况下,“nosuchdomain”也会缓存,下次查询时不再转发
到上游服务器而直接应答,这个选项将禁用“nosuchdomain”返回
的缓存
authoritativedhcp-authoritative我们是局域网的唯一的DHCP服务器,当收到请求后会立即响应,
而不会等待,如果拒绝的话也会很快拒绝
readethersread-ethers从/etc/ethers文件中读取静态分配的表项。格式为硬件地址和主机名
或IP地址,当收到SIGHUP信号时也会重新读取
resolvfileresolv-file指定一个DNS配置文件来读取上游域名服务器的地址,默认是从
/etc/resolv.conf文件读取
2.DHCP地址池配置
类型为dhcp的配置节指定了每一个接口的DHCP设置,通常最少有一个服务于局域
网接口的dhcp配置设置。
示例11-2:
configdhcplan
optioninterfacelan
optionstart100
optionlimit150
optionleasetime12h

示例11-2指定了DHCP服务器的服务接口“lan”,100是客户端分配的IP地址起点,
总共可以分配150个IP地址,即从100~249。12h表示客户端得到的地址租约时间为12
小时。DHCP配置参数含义如表11-2所示。
表11-2DHCP配置参数含义
名称含义
interface表示服务的网络接口,这个接口名称是network中配置的虚拟接口
start分配IP的起始地址
limit地址空间范围,默认为150
leasetimeDHCP分配IP地址的租期,start和limit在生成dnsmasq的配置文件时进行组合为dhcp-range
ignorednsmasq将忽略从该接口来的请求
3.域名配置
dnsmasq支持自定义主机或者是自定义域名,使用domain配置节来管理自定义域名。
我们使用uci命令来增加两条自定义域名记录。首先创建一个类型为domain匿名的配置节,
然后设置其名称和IP地址。示例11-3创建了两个匿名配置节,然后使用ucicommit命令
提交修改。
示例11-3:
root@zhang:/#uciadddhcpdomain
root@zhang:/#ucisetdhcp.@domain[-1].name="zhang"
root@zhang:/#ucisetdhcp.@domain[-1].ip="192.168.6.10"
root@zhang:/#uciadddhcpdomain
root@zhang:/#ucisetdhcp.@domain[-1].name="bjbook.net"
root@zhang:/#ucisetdhcp.@domain[-1].ip="192.168.6.20"
root@zhang:/#ucicommitdhcp
记录被写到/etc/config/dhcp文件中,但现在功能并未生效。调用重启dnsmasq进程命
令来使dnsmasq读取这些配置更改,命令为/etc/init.d/dnsmasqrestart。生效后内容如下:
configdomain
optionname`zhang`
optionip`192.168.6.10`
configdomain
optionname`bjbook.net`
11.4dnsmasq227
optionip`192.168.6.20`
实际的配置将转换为dnsmasq的配置,配置文件为/var/etc/dnsmasq.conf。
然后在OpenWrtshell中ping主机名称bjbook.net。这时将访问192.168.6.20这个IP
地址,并从192.168.6.20收到响应。这和主机系统的功能完全相同,只是在/etc/hosts文件
中只在本机生效,如果加载这里就可以服务于家庭网。domain配置选项见表11-3。
表11-3domain配置选项
名称类型含义
name字符串主机的域名,这个域名将不在因特网上查询
ipIP地址域名对应的IP地址
4.主机配置
DHCP在分配IP时,选择一个未使用的IP地址进行分配。假定有一个服务器,也是
通过DHCP进行IP分配的,这样每次重启后分配的IP地址可能发生改变,这在访问服务
器时还需查看其IP地址。根据MAC地址分配固定IP地址可以解决这个问题。在DHCP
配置文件中使用host来配置。如示例11-4所示。
示例11-4:
confighost
optionip'192.168.6.120'
optionmac'08:00:27:9d:89:e7'
optionname'buildServer'
通过uci命令进行增加:
root@zhang:/#uciadddhcphost
root@zhang:/#ucisetdhcp.@host[-1].ip="192.168.6.120"
root@zhang:/#ucisetdhcp.@host[-1].mac="08:00:27:9d:89:e7"
root@zhang:/#ucisetdhcp.@host[-1].name="buildServer"
root@zhang:/#ucicommitdhcp
这将增加固定的IP地址192.168.6.120。然后重启DHCP服务器,这时MAC地址为
“08:00:27:9d:89:e7”的计算机再次获取的IP地址将设置为固定IP地址192.168.6.120,主机
名称设置为buildServer。固定主机配置选项如表11-4所示。

表11-4指定固定IP的host配置选项
名称类型含义
ip字符串客户端所获得的IP地址
mac字符串主机的网卡MAC地址
name字符串DHCP客户端所获取到的主机名称,是否使用由客户端决策
5.DHCP客户端信息
DHCP还有一个功能是记录客户端列表。客户端列表显示当前所有通过DHCP服务器
获得IP地址主机的相关信息,包括客户端主机名称、MAC地址、所获得的IP地址及IP
地址的有效期。表11-5列出了所有保存字段的含义,我们可以通过/tmp/dhcp.leases文件来
查看所有通过DHCP服务器获得IP地址的计算机信息。
表11-5DHCP分配的客户端信息
类别含义
有效时间(租期)指客户端计算机获得IP地址的有效时间,是指从1970年开始的一个秒值,到
这个时间之后地址将失效,客户端软件会在租期到期前自动续约
MAC地址获得IP地址的客户端计算机的MAC地址
IP地址DHCP服务器分配给客户端计算机的IP地址
客户端名称显示获得IP地址的客户端计算机的主机名称

11.5 动态DNS
-----------------------------------------------------------

11.5.1 DDNS原理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

利用DNS可以将域名解析为IP地址,从而实现使用域名来访问网络中的主机。但是DNS仅仅提供了域名和IP地址之间的静态对应关系,当主机的IP地址发生变化时,DNS服务器没有动态地更新域名和IP地址的对应关系,此时如果仍然使用域名访问该主机,则通过域名解析得到的IP地址是错误的,从而将导致访问失败。动态域名系统(DynamicDomainNameSystem,DDNS)用来动态更新DNS服务器上域名和IP地址之间的对应关系,从而保证通过域名解析到正确的主机IP地址。
DDNS采用客户端/服务器模型,由两部分组成,分别为DDNS客户端和DDNS服务器。

DDNS客户端:需要动态更新域名和IP地址对应关系的设备软件。因特网用户通常通过域名访问提供应用层服务的服务器,如HTTP、FTP服务器。为了保证IP地址变化时,仍然可以通过域名访问这些服务器,当服务器的IP地址发生变化时,它们将作为DDNS客户端,向DDNS服务器发送更新域名和IP地址对应关系的DDNS更新请求。
DDNS服务器:负责通知DNS服务器动态更新域名和IP地址之间的对应关系。接收到DDNS客户端的更新请求后,DDNS服务器通知DNS服务器重新建立域名和IP地址之
间的对应关系。从而保证即使DDNS客户端的IP地址改变,网络用户仍然可以通过同样的域名访问DDNS客户端主机提供的网络服务。

11.5.2 DDNS配置
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

OpenWrt通过Ez-Ipupdate软件来支持DDNS,常用的DDNS配置在表11-6中做了详细
说明。通过以下命令来安装DDNS客户端。
opkgupdate
opkginstallez-ipupdate
表11-6DDNS详细配置
名称类型含义
enabled布尔值是否启动DDNS客户端
interface接口名称设置该DDNS所绑定的接口,DDNS更新的域名所对应的IP地址
为该接口的主IP地址
service字符串服务类型,支持很多种DDNS更新协议,我们使用gnudip
username字符串设置DDNS服务器的认证用户名
password字符串设置DDNS服务器的认证密码
hostname字符串绑定的域名后缀,一般为服务提供商域名

11.5.3DNS更新协议及算法
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

我们采用Ez-Ipupdate客户端和GnuDIP服务器来讲述DDNS更新认证算法。GnuDIP实际上有两个更新协议,原始更新协议采用客户端到服务器的直接TCP连接;另外一种则适配原始协议到HTTP协议。HTTP协议对于一些动态DNS更新客户端实现起来更方便。这两个协议均不能通过嗅探抓包软件找出明文密码,也不能使用捕获的报文来重放欺骗更新服务器,即可以防止重放攻击。Ez-Ipupdate向GnuDIP更新的流程如图11-8所示。
(1)客户端首先向服务器发起TCP连接请求,端口默认为3495,GnuDIP服务器可以
修改为其他端口。
(2)一旦TCP连接建立,服务器将首先发送一个随机产生的10字符长度的字符串,
我们称之为sessionKey。
(3)客户端收到并读取服务器的认证字符串。然后使用下列算法来对密码和nonce进行哈希。
hashed_password=F(password,sessionKey)
F(password,sessionKey)=MD5(MD5(password)+"."+sessionKey)
MD5函数使用MD5算法对密码计算摘要值,然后将摘要值(二进制)转换为十六进
制(使用字符0~9和小写字母a~f)的字符串,字符串长度从16字节变为32字节。
-首先计算出密码摘要值,并转换为十六进制数字。
-auth拼接一个点“.”再拼接一个认证字符串sessionKey(这个是服务器传输过来的值)。
-然后对整个拼接的字符串计算MD5摘要值,并转换为十六进制数字,我们称之为
认证字符串“hashed_password”。
-将用户名、认证字符串、域名及地址组成认证信息向动态域名更新服务器GnuDIP
发起请求,消息组成格式如下:
user_name:hashed_password:domain:0:address
(4)GnuDIP服务器收到请求后采用同样的算法计算认证字符串,并将计算结果和请

求的认证字符串进行比较,如果相同,则认证通过,更新域名和IP地址的对应关系,并
向客户端发送更新成功消息;如果不相同,则认证失败,发送更新失败消息。
图11-8DDNS动态更新域名IP时序图
注册消息的响应有以下两种情况。
-1:表示登录出现错误,通常是密码错误。
-0:更新成功。
IP地址将注册为子域名user_name.domain。假设服务器域名为bjbook.net,那注册的
子域名将是user_name.bjbook.net。除了注册消息之外,DDNS客户端和服务器之间还有两
种消息,分别为下线消息和查询消息。下线消息格式为:
user_name:hashed_password:domain:1
当前注册到user_name.domain的IP地址将被删除,这是下线请求,正式域名user_
name.domain将不再关联任何IP地址。这条消息的响应有以下两种情况。
-1:表示登录出现错误,通常是密码不正确导致。
-2:成功下线。
查询消息格式为:
user_name:hashed_password:domain:2

客户端请求服务器确定客户端正在使用的IP地址,并注册到正式域名user_name.
domain上。这时IP地址将返回到客户端。这条消息的响应有以下两种情况。
-返回“1”,表示登录出现错误,通常是密码不正确导致。
-返回“0:address”表示成功地更新到提供的IP地址上。

11.6DNS测试工具
-----------------------------------------------------------

11.6.1nslookup
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

“nslookup”是一个命令行域名查询工具,有两种工作模式:交互式和非交互式。交互方式用于向域名服务器查询各种主机和域名信息并输出。非交互模式仅向服务器查询请求的信息。非交互式模式用于查询主机名或主机IP地址为第一个参数,可选的第二个参数为域名服务器IP地址。其他选项参数以“-”开始。例如,我们可以查询一个恶意域名,并把它的IP地址加入到防火墙黑名单中。
(1)查询域名IP地址。例如:
$>nslookupopenwrt.org
(2)指定域名服务器来查询域名IP地址。例如:
$>nslookupopenwrt.org8.8.8.8
(3)查询IP地址的域名,即进行反向查询。例如:
$>nslookup8.8.8.8
11.6.2dig
dig是另一款域名查询工具,其功能非常强大,并且可以指定源IP地址,这在主机上
11.6DNS测试工具233
有多个接口及IP地址时非常有用。其最基本的用法如下:
#>dig@serverbaidu.com
@后面表示DNS服务器地址。
#>dig-b192.168.1.100baidu.com
“-b”表示指定源IP,在系统有多个接口地址时使用。
dig提供了大量的查询选项和输出结果显示选项。一些查询选项会设置查询报头的标
志位,有些是设置超时和重试策略,还有些是控制屏幕输出。dig的查询选项和其他软件
不同,采用“+”开头的标识符来表示。
dig还有很多选项可以定制查询和输出。例如+short可以简化输出。默认dig会输出
DNS报头信息,包含查询问题个数和回答问题个数等信息。输出如示例11-5所示。
示例11-5:
zhang@zhang-VirtualBox:~$dig@8.8.8.8baidu.com
;<<>>DiG9.9.5-3ubuntu0.1-Ubuntu<<>>@8.8.8.8baidu.com
;(1serverfound)
;;globaloptions:+cmd
;;Gotanswer:
;;->>HEADER<<-opcode:QUERY,status:NOERROR,id:65069
;;flags:qrrdra;QUERY:1,ANSWER:4,AUTHORITY:0,ADDITIONAL:1
;;OPTPSEUDOSECTION:
;EDNS:version:0,flags:;udp:512
;;QUESTIONSECTION:
;baidu.com.INA
;;ANSWERSECTION:
baidu.com.588INA220.181.57.217
baidu.com.588INA111.13.101.208
baidu.com.588INA123.125.114.144
baidu.com.588INA180.149.132.47

;;Querytime:81msec
;;SERVER:8.8.8.8#53(8.8.8.8)
;;WHEN:SatNov1419:57:07CST2015
;;MSGSIZErcvd:102
dig在进行域名查询时,如果第一个域名服务器无响应,将在1秒后向第二个DNS地址发起请求。在这点上它和nslookup不同,nslookup需要等待5秒之后再向第二个域名服务器发起查询请求。