10.OpenWrt-ip路由
===========================================================

路由就是把报文从源主机传输到目标主机的过程,报文根据路由表来进行路由。本章首先对路由进行分类,接着讲述了根据目的地址路由,为了更灵活的路由报文而产生了根据源地址的策略路由,最后讲述了D类IP地址的组播路由。

10.1 路由分类
-----------------------------------------------------------

智能路由器上最重要的功能是IP路由。IP报文根据路由表进行路由决策,路由表中
的路由项又有各种不同的分类,按目的地址类型不同可划分为单播路由和组播路由。单
播路由表中保存了各种路由协议发现的路由。根据路由表项的来源来划分,通常分为以
下3类。
(1)接口路由。也称为直连路由,当设置接口IP地址和掩码时会自动增加的路由,
是报文通往该接口IP地址所在网络的路由。
(2)静态路由。网络管理员手工配置的路由。当网络结构比较简单时,只需配置静态路由就可以工作,适用于拓扑结构简单并且稳定的小型网络。静态路由不能自动适应网络拓扑结构的变化,当网络发生故障或者拓扑发生变化后,必须再次由网络管理员手工修改配置。
(3)动态路由。动态路由协议发现并设置路由,常见的动态路由协议有RIP、OSPF
和IS-IS等。路由表会根据链路状态或网络拓扑结构变化进行动态生成和删除。常见的动态路由软件有Zebra和Quagga等。在智能路由器领域一般只有唯一的互联网出口,因此不会用到动态路由。

根据路由目的地址的不同,路由可划分为以下两类。
(1)网络路由。目的地为网络地址,子网掩码长度小于32位
(2)主机路由。目的地为主机地址,子网掩码长度为32位,通常主机路由的优先级更高。按路由决策的方式不同,路由可划分为以下两类。
(1)策略路由。也称为源地址路由,根据IP报文源地址、端口、报文长度、优先级等内容灵活地进行路由选择。
(2)普通的目的地址路由。仅根据报文目的地址来选择出接口或者下一跳地址。另外,根据目的地与该路由器是否直接相连,路由又可划分为以下两类。
(1)直接路由。目的地所在网络与路由器直接相连。
(2)间接路由。目的地所在网络与路由器非直接相连。
还有一个概念是缺省路由,也称默认路由,是指在路由器中没有找到精确匹配路由表
项后所使用的路由。如果报文的目的地址在路由表中没有找到匹配的路由,而且还没有默
认路由,那么该报文将被丢弃并向报文的源地址发送一个网络地址不可达的ICMP差错报
文。智能路由器的默认路由通常是通过DHCP或PPPoE自动获取下一跳地址后,动态生
成并写入到路由表中的。

10.2 单播路由
-----------------------------------------------------------

报文的目标地址为A、B、C类地址的路由表项为单播路由。目标IP地址是告诉报文
目的主机地址在哪里,而路由是告诉报文如何到达目的地址。网络上的每个路由器独立进行
决策,将报文转发到离目的地址更近的路由器上,就这样一步一步地路由到目标主机上。

10.2.1路由表管理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

首先我们来看一下OpenWrt机器的路由表,示例10-1执行“route–n”命令来列出路

由表项,-n选项表示列出数字地址形式,而不是主机名或者域名。route命令是用于管理
和维护操作系统内核的路由表,主要用于设置到特定主机或网络的静态路由。可以增加、
删除及查看路由表等。
示例10-1:
root@zhang:~$route-n
KernelIProutingtable
DestinationGatewayGenmaskFlagsMetricRefUseIface
0.0.0.010.0.2.20.0.0.0UG000eth0
10.0.2.00.0.0.0255.255.255.0U000eth0
192.168.56.00.0.0.0255.255.255.0U000eth1
第一行是一个默认路由,这表明如果没有精确匹配路由,就会将IP报文发送到IP地
址10.0.2.2上。UG表示一个启用的网关地址。eth0表示出接口地址。
第二行是一个接口路由,表示该接口eth0和10.0.2.0/24网络相连。这在接口配置IP
和掩码时会默认自动设置上。如果不设置掩码则默认A类地址为8位掩码,B类地址为16
位掩码,C类地址为24位掩码。
第三行也是一个接口路由,为局域网接口的路由项,表示局域网为192.168.56.0网段。
eth1表示通过该网卡和局域网网络相连接。路由各个字段含义如表10-1所示。
表10-1路由表含义
字段含义
Destination目的网络/主机的IP地址
Gateway网关地址,即路由的下一跳地址,如果全为零表示没有网关地址
Genmask网络掩码,以IP地址形式表示,255.255.255.0表示24位掩码
Flags路由表项标识
Metric路由优先级
Ref该路由表项的引用数
Iface转发报文出接口名称,即符合这条路由的报文将从此接口转发出去
对于给定的路由表项的路由标识通常有以下几种。
- U:路由表项可以使用。
10.2单播路由197
- H:路由表项的目标地址是主机地址,即掩码为32位。
- G:路由表项下一跳为网关。
- R:动态路由算法生成的。
- D:该路由通过重定向或者守护进程动态安装的。
- M:该路由被路由守护进程或重定向报文修改。
- A:该路由被addrconf安装。
- C:缓存(cacheentry)。
- !:拒绝路由(rejectroute)。匹配这一条报文将丢弃。
每当增加一个接口IP时将自动创建一个直连的接口路由。对于通过DHCP获得的IP地址,除了设置直连路由外还可能会设置网关的默认路由。使用ip命令和route命令均可对路由表进行管理,默认路由通过以下两个命令均进行设置。
#>iprouteadddefaultvia<gwip>deveth0
#>routeadddefaultgw<gwip>deveth0
这两个命令行为完全相同,只是ip命令使用Netlink接口设置到内核中,route命令通过传统的ioctl接口设置到内核中。Linux内核已经不建议使用ioctl接口。针对目的IP,如何来选择路由表项？路由表中的信息包含了IP层的决策。采用最长匹配算法来匹配,如果有多个匹配则会随机选择一个作为路由。我们可以使用“iproute get”命令来查看匹配的路由。
root@zhang:~$iprouteget8.8.8.8
8.8.8.8via10.0.2.2deveth0src10.0.2.15
cache
为了系统的稳定性,操作系统将路由功能划分为两部分。
(1)管理平面,也称为控制平面。是指用于路由学习,生成路由表的部分。Linux用户空间的程序就属于管理平面。
(2)转发平面,也称数据平面(DataPlane)。转发平面是指系统中进行数据报文的接
收、查找路由表、根据路由表进行决策等的部分。转发平面在Linux内核中。路由器可以实现转发面和管理平面的相互独立。为了做到控制平面和转发平面的分离,Linux内核构建了一张转发表,专门用于指导数据报文的转发。用户空间的应用层软件形成控制平面的路由表,可能会有多种可选的路由规则,但路由软件系统会计算出一条最佳的路径然后写入内核中。两者之间通过接口(Netlink)来实现相互操作。在小型智能路由器上网络比较单一,路由表项不用动态生成,只有固定的路由表。因此一般不会使用quagga路由软件生成的控制平面的路由表,只有静态路由。在小型智能路由器上可以认为两者完全相同。数据平面保存的路由表,也称为路由转发表(ForwardingInformationBase,FIB),用来指导IP报文的转发,转发算法如下。
(1)组织和存储选出的路由表项。
(2)按照LPM(最长掩码匹配)算法提供路由检索接口。报文的转发过程为:首先网卡接口上接收报文,并查看报文的目的地址:然后根据目的地址来查询转发表;最后按查询到的路径把分组报文转发出去。在增加静态路由时需注意:在Windows下增加静态路由,必须设置有下一跳地址;在Linux下增加静态路由时,可以仅设置出接口而不设置下一跳地址。
如果增加静态路由时仅设置出接口而不设置下一跳地址,在一些没有开启ARP代理的设备上将会遇到不能连通网络的问题。因为使用出接口地址时,Linux会认为目标地址网络是直连可达的网络,将直接发出ARP请求来查询目标IP地址的MAC地址,如果路由器没有启动ARP代理,就不会发出ARP响应消息,这时Linux就会因为找不到目标MAC地址而转发失败。如果直接指定网关地址,那ARP请求就直接请求网关地址的MAC地址,然后进行报文转发。

10.2.2静态路由配置
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

使用命令行对路由表进行设置时,在重启之后配置均需重新设置。OpenWrt的静态路由配置在配置文件/etc/config/network的route配置节中,在启动过程中netifd模块会读取该配置文件并进行设置。可选的配置选项见表10-2。

表10-2静态路由配置含义
选项类型含义
interface字符串三层网络接口名称,例如为“wan”
target字符串目的主机IP或目的网络地址
netmask字符串如果target为网络地址,在这里需要填写网络掩码,例如为
255.255.255.0
gateway字符串网关地址,即IP报文的下一跳地址
metric整型数字路由的优先级
mtu整型数字该路由的IP报文最大传输单元
table整型数字路由表,默认为main表,通常不用设置,如果开启策略路由则需
要设置
例如局域网还有一个192.168.9.0/24网络,那么我们将增加示例10-2所示的配置,就
可以通过网关地址192.168.6.10到达192.168.9.0/24网络。
示例10-2:
configroute
optioninterface'lan'
optiontarget'192.168.9.0
optionnetwork'255.255.255.0
optiongateway'192.168.6.10'
进行重启后,使用route-n命令来查看,路由表增加了以下内容:
192.168.9.0192.168.6.10255.255.255.0UG000br-lan

10.3策略路由
-----------------------------------------------------------

10.3.1概述
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

策略路由提供了一种比基于目的地址进行路由转发更为灵活的数据包路由转发机制。策略路由可以根据IP报文源地址、目的地址、传输端口、报文长度和优先级等内容灵活地进行路由选择。现有用户网络,常常会出现使用到多个Internet服务提供商(InternetServerProvider,ISP)资源的情形,不同ISP申请到的带宽大小不同;同时,由于在企业用户环境中需要对重点用户资源保证等目的,对这部分用户不能够再依据普通路由表进行转发,需要有选择地进行数据报文的转发控制,因此策略路由技术即能够保证ISP资源的充分利用,又能够很好地满足这种灵活多样的应用。策略路由处理的优先级高于普通路由,因此在接口收到报文后进行处理时,在策略路由处理完成之后,再进行普通路由决策,转发出的报文将不再进入策略路由处理。在系统设置策略路由后,将对该系统接收到的所有报文进行检查,不符合任何策略路由的数据报文将按照普通的路由转发进行处理,符合路由中某个策略的数据包就按照该策略中定义的路由表进行报文转发。策略路由通常由两部分组成:匹配策略表和自定义路由表。匹配策略表是由很多条策略组成的,每条匹配策略都有对应的序号,序号越小,该条策略的优先级越高。在策略路由转发过程,报文依策略优先级从高到底依次匹配,只要匹配前面的策略,就执行该策略对应的动作或进入相应的策略路由表,然后退出策略路由的执行。自定义路由表和普通的路由表完全相同,只是其带有特殊的路由表编号,通常使用1~252之间的数字来编号。

10.3.2配置策略路由
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

(1)路由表的管理。在单播路由中,我们通常使用route命令来对路由表进行管理,
这个命令是主路由表(main)进行操作和管理的。其实Linux系统默认有3个路由表,分
别为:
- 本地路由表(local),路由表编号255。本地路由表负责本机IP地址和广播地
址的路由,内核将自动维护这个路由表,如果没有该路由表则任何网络都不能
访问。
- 主路由表(main),路由表编号254。通常的单播路由均保存在主路由表中。
- 默认路由表(default),路由表编号253。默认路由表通常没有任何路由表项。
Linux系统可以处理1~231个路由表,路由表名称和编号之间的对应关系由/
etc/iproute2/rt_tables来指定。默认情况下所有的路由均插入到主路由表中,除了内置的3

个路由表外,其他的路由表来源于策略路由。可以使用“iproute”命令来管理多个自定义的路由表,使用“table”关键字来指定路由表编号,如果没有指定则将加入到主路由表中。用于管理路由表的命令通常有以下4种。
- iprouteadd:增加路由。通常有以下几个参数。
PREFIX(default):路由的目的前缀,是一个IP地址后跟一个斜线和掩码长度。如果没有掩码,则就是一个主机路由。如果为“default”则为默认路由,表示IP地址0/0,即匹配所有的目标IP地址。
tableTABLEID:这条路由所在的表,TABLEID可以是数字或者是配置文件/etc/
iproute2/rt_tables的字符串。如果这个参数忽略,那将加入到主路由表中。
devNAME:报文输出的网卡设备名称。
viaADDRESS:报文的网关地址,即下一跳地址。
srcADDRESS:发送这个路由报文所使用的源地址。
- iproutedel:删除路由。删除命令和增加路由命令的参数相同,如果指定的路由没找到,则删除失败。
- iproutelist:列出路由表的内容,经常指定路由表名称或编号来查看。
- iprouteget:这个命令用于传递一个IP地址,并列出该目标地址的内核路由,这
个路由就是内核实际转发该目标地址报文的路由。
(2)策略表管理。Linux系统匹配策略表的缺省配置如示例10-3所示,即有3条默认的匹配规则,匹配所有的报文依次进入系统的3个默认路由表中进行处理。如果使用策略路由,通常会新增自定义匹配规则。
示例10-3:
root@zhang:/>iprule
0:fromalllookuplocal
32766:fromalllookupmain
32767:fromalllookupdefault
匹配策略表默认有3条规则,编号越小,优先级越高。

标号0的匹配规则是优先级最高的规则,所有的报文都要进入本地路由表(local)中
进行处理,如果删除,则不能访问任何网络。这个本地表负责本机IP地址和广播地址的路由。
标号32766,匹配所有的报文,使用主表(main)进行路由。这个主表就是普通的单播路由表。
标号32767,匹配所有的报文,使用默认表(default)进行路由。通常这个默认表都是空的。
通常系统中默认匹配策略表不要进行修改。报文按照编号由低到高依次匹配规则,匹配规则后就执行相应的动作。这里首先匹配编号0的规则,然后在本地路由表中进行路由查找,如果报文的目标地址是本机IP或者是广播地址,则会在本地路由表中查找到路由,然后进行路由转发。如果找不到路由则跳出这个本地路由表匹配下一条策略规则。这里是标号32766,将会跳入到主路由表中进行路由查找。主路由表中通常如示例10-1所示,找到一条路由,然后就结束路由过程。如果还没有找到路由,则匹配标号32767的规则,进入默认路由表中进行路由查找。每条策略是由一个或者多个匹配条件组成的。匹配语句定义了IP报文的匹配规则和对符合匹配规则的IP报文的处理动作。策略路由提供了很多种类型的匹配规则,分别是
from、to、tos、fwmark、iif和oif。对于同一条策略,可以配置多个匹配规则。如果在同一条策略中包含多个匹配规则,那么只有同时满足全部匹配规则的IP报文才会执行该策
略中指定的动作。
匹配策略表通常使用“iprule”命令来进行管理。命令格式如下:
iprule[list|add|del|flush]SELECTORACTION
SELECTOR就是选择匹配规则,可以根据报文的以下几个部分进行匹配。
from:根据源地址进行匹配。
to:根据目的地址进行匹配。
iif:选择报文的源设备接口去匹配,如果接口是回环接口,则规则仅匹配本机产生的
报文。这意味着你可以创建单独的路由表去处理转发报文和本机产生报文,以此来完
全分隔它们。oif:选择报文发出设备去匹配。发出接口仅仅针对本机产生的报文,这些报文通过绑定本地socket来发送数据。tos:报文的服务类型。fwmark:选择防火墙值fwmark去匹配。这个值通常由iptables来设置。策略路由提供了4种类型的动作语句(ACTION),常用的有两类。第一类用于匹配之后结束策略路由跳转到对应的路由表,通过table关键字来指定。第二类用于控制IP消亡,包括prohibit、reject和unreachable。策略路由通常由以下三步来实现,首先需要定义一个路由表,这个表用于指定报文转发到目的地址的路由。路由表是一组路由规则组成的,路由表名称默认在/etc/iproute2/rt_table中定义。
其次,在自定义的路由表中增加匹配后的路由规则,这和普通静态路由相同,由用户或程序来添加。最后,使用iprule语句控制报文匹配行为。报文匹配控制是通过在策略表中定义一组iprule语句而实现的;依序使用每一个规则语句进行报文匹配,匹配后进入相应的路由表;每一个语句都会独立决策,通常不会引用前面或者后面的语句。如果不匹配任何策略,则按普通路由转发。在OpenWrt15.05中已经支持UCI方式进行自定义路由表的配置,在/etc/config/network中进行配置,但还不支持策略路由配置。

10.3.3典型配置举例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

假设某公司有两个带宽接入网络,但是外出的带宽还是经常不够用,那么我们就需要保证VIP人士的带宽,这时我们就可以采用策略路由来实现。将VIP计算机的IP地址加入到策略路由中,专走质量稳定并且带宽较大的B路由,其他人员走默认路由A路由。网络拓扑如图10-1所示,有两条不同的路径接入网络。假设我们接入互联网有固定的静态IP地址:第一个为10.0.2.15,经过网关地址10.0.2.2接入互联网,物理接口为eth0;第二个接入网络的固定静态IP地址为172.16.100.2,经过网关172.16.100.1接入互联网,物理接口为eth1。

图10-1策略路由环境图现在我们设置VIP主机选择172网段路由接入互联网。其他主机通过10网段路由接入互联网。我们使用ip命令在路由器中创建两条路径,分别路由来自不同IP地址的数据包。在Linux中策略路由优先选择,因此我们将VIP主机进行策略路由,其他主机通过默认路由来实现。
(1)创建策略路由表。在rt_table里面建立新的路由表VIP表,编号为200。这步不
是必须的,但为了明确区分路由表而设置,后面使用VIP和200的含义相同。
#>echo"200vip">>/etc/iproute2/rt_tables
(2)将B出口的路由加入到自定义路由表VIP中。
#>iprouteadddefaultvia172.16.100.1tablevip
#>iprouteadd172.16.100.0/24deveth1tablevip
(3)配置VIP的源IP地址到VIP路由表中查找。
#>ipruleaddfrom192.168.6.100/32tablevip
这时VIP主机已经可以通过专用通道访问网络了。我们使用ping命令来验证网络是否连通。但普通主机因为没有默认路由还不能访问网络,我们创建路由如下:
#>iprouteadddefaultdeveth0via10.0.2.2
注意以下几种情况。
- 在使用ping来进行验证时,如果提示端口不可达(DestinationPortUnreachable),一般是因为防火墙禁止转发导致,可以关闭防火墙再进行验证。
- 如果提示主机不可达(DestinationHostUnreachable),则通常为路由规则配置不正确,或者目标主机确实不存在导致。

- 如果没有任何提示,则报文可能已经到达目的主机,只是目的主机的响应报文因为没有路由规则而没有发送成功。

10.4组播路由
-----------------------------------------------------------

10.4.1组播原理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

为了让网络中的多个客户端可以同时接收到相同的报文,例如互联网直播电视,如果采用单播的方式,那么服务器必须同时产生很多份相同的报文来进行发送,并且路由器也需要转发多份完全相同的报文,这增加了服务器主机和路由器的负担。组播路由在这种情况下应运而生。采用组播的方式,源主机只需要发送一份报文到组播地址,加上路由器的组播路由支持,就可以到达每个需要接收的主机上。路由器根据组播路由协议来对组成员和组关系进行维护和生成组播路由。组播的优势是不论网络中的用户数量有多少,服务器仅发出一个数据流,由网络中的路由器或交换机同时转发多个组播流到每个用户,每个链路仅有一份流量的带宽。可见IP组播能够有效地针对这种直播场景节省网络带宽和资源,管理网络的增容和控制开销,大大减轻发送服务器的负荷,达到发送信息的高效。在单播环境里,如果有100个用户,视频服务器依次传输100个信息流到网络中的用户,假设信息流为1M带宽,则一共需要100M的带宽。服务器网络带宽是一个巨大的瓶颈。而在组播环境下仅占用1M带宽。组播数据在传输层封装为UDP报文进行传输。在IP层,组播把224.0.0.0~239.255.255.255的D类地址作为组播目的地址,还有更为具体的分类(见表10-3)。任何一台主机均可以发出目的地址是D类地址的报文。在网络中,如果有其他主机对于某组播组感兴趣,可以申请加入这个组,并设置为接收这个组的报文,而其他不是这个组的成员是无法接收到这个组播组的报文的。为了使主机能收到组播报文,接口需要在组播地址进行监听,因此主机需要指定组播的MAC地址,在IP地址到链路地址转换过程中,组播使用专用的MAC地址范围,MAC组播地址是由IP组播地址转换过来的。组播MAC地址开始六字节是01-00-5E,例如组播地址为236.0.0.1,转换为二进制取最右边23位,即组播地址为01-00-5E-00-00-01。IP组播地址使用28位来表示,而以太网组播地址使用23位地址,因此32个IP组播地址映射到同一个MAC地址。组播MAC地址范围如下:01-00-5E-00-00-0001-00-5E-7F-FF-FF实现组播的关键在于路由器支持组播路由,因此需要创建组播路由并按照组播路由表对组播报文进行路由。组播路由表的创建,可以有3种方式。
(1)静态组播路由。
(2)PIM协议
(3)IGMP代理。
PIM和IGMP代理实现了对组员和组之间关系的维护机制,可以明确知道在网络是否有主机对这类组播报文感兴趣,如果没有就不会把报文进行转发,并会通知上游路由器不要再转发这类报文到下游路由器上。静态组播路由需要进行手动设置,不会进行动态维护,只能由管理员设置。如果所有接口均转发组播路由,那将大大增加网络的负担,因为有些网络没有客户端用户。因此仅有组播路由表项的报文才能转发。组播路由表和普通单播路由表完全不同,是根据源接口、源IP、目的地址及目的接口共同决定的。源接口是上游接口。和单播路由一样,每当路由器转发组播数据报文时,IP包中的TTL值都会减1。若数据报文的TTL减少到0,则路由器将抛弃该数据报文。这样可以在源主机发出组播报文时设置为较少的值来对组播范围加以控制,例如公司内部局域网内,可以设置组播报文TTL为4,这样组播报文最多跨越3台路由器。
常见永久组播地址及含义见表10-3。
表10-3常见永久组播地址及含义组播地址含义224.0.0.0~224.0.0.255本地网络控制组播组地址。其TTL值应当为1,但路由器不论TTL值为多少,都不应当转发这些组播报文239.0.0.0~239.255.255.255管理用途的组播地址。这些地址被分配给每一个组织内部使用,组织内的路由器不能将这些地址的组播报文转发到组织外部。不向在组织外的地址提供路由。参见RFC2365

续表
组播地址含义
224.0.0.1所有主机(包括路由器)均在该地址监听
224.0.0.2所有的路由器均在该地址监听
239.255.255.250UPNP组播地址

10.4.2 IGMP原理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

互联网组管理协议(IGMP)是一个由主机和路由器之间使用的IPv4相邻网络建立组播,并维护组成员关系的通信协议。IGMP是IP组播的一个组成部分。IGMP可用于一对多的网络应用如直播视频,并允许更高效地利用网络资源,支持这些类型的应用程序。IGMP用于IPv4组播。它是TCP/IP协议族中负责IP组播成员管理的协议,用来在主机和与其直接相邻的路由器之间建立和维护组播组成员关系。IGMP协议和ICMP协议一样运行在网络层。主机发送请求加入本地路由器所管理的组播组中,而路由器监听这些请求,并定期发送订阅查询。如表10-4所示,通常有4种类型的报文,即组播查询消息报文、离开组播组消息报文、组成员查询消息报文和组成员报告消息报文。
表10-4常见IGMP组播消息含义消息类型目的地址含义
组播查询消息224.0.0.1所有主机均在该地址监听,组播路由器向该地址发出查询,是否还有组播客户端离开组播组消息224.0.0.2所有的路由器均在该地址监听。主机发出的目的地址为224.0.0.2报文,告诉路由器主机离开了组播组组成员查询消息正在查询的组播地址向组播地址查询是否有组播成员,如果没有组播成员将删除组播路由组成员报告消息要加入或已加入的组播地址报告组播组里还有组播成员存在

10.4.3 IGMP代理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在家庭网的树状网络拓扑中,路由设备上并不需要运行复杂的组播路由协议(如PIM),可以通过在这些设备上配置IGMPProxying(IGMP代理)功能,使其代理下游主机来发送IGMP报文及维护组成员关系,并基于该关系再次加入上级组播组。在上游设备来看,配置了IGMP代理功能的设备不再是一个路由设备,而仅是一台主机。IGMP代理将会主导组播组的创建工作。当有一个用户IGMP请求接收上来时,IGMP代理首先会检查本地的组播组,如果在本地这个组播组已经存在,那么就把该用户IP地址加入到这个组播组的成员列表中,而不需要向上行路由器发送加入消息。如果在本地没有找到相应的组播组,那么IGMP代理就会向上级的路由器发送加入消息,并在本地创建组播组并设置组播路由。在组播成员退出的时候,IGMP代理首先检查该组播组中是否还有其他的组播成员存在,如果还有其他成员那就只是把组播组中申请退出的成员删除;如果是最后一个成员退出它就会通知上级的路由器,并在本地销毁组播组及删除组播路由。创建的组播路由通过ipmroute命令来查看。
#>ipmroute
(10.0.1.1,236.0.0.1)Iif:eth0Oifs:br-lan组播路由由4部分组成。源地址是报文的发起者,目标地址为组播地址,是目的主机所要接收的组播报文地址。Iif为报文进入接口,只有从该接口进入的报文才会被转发。Oifs为报文转发出口地址,组播报文从这里转发给目标主机。IGMP代理中定义了以下两种接口类型。
(1)上行接口。又称代理接口,指IGMP代理设备上运行IGMP代理功能的接口,即朝向组播分发树树根方向的接口。该接口在上行路由器来看是执行IGMP协议的主机行为。
(2)下行接口。指IGMP代理设备上除上行接口外其他运行IGMP协议的接口,即背向组播分发树树根方向的接口。该接口在家庭网内主机来看是执行IGMP协议的路由器行为。IGMP代理设备上维护着一个组成员关系的数据表,所有下行接口维护的组成员关系记录都存到这个数据表中。上行接口正是依据这个数据表来执行主机行为的,当收到查询报文时根据当前数据表生成状态响应报告报文,或者当数据表变化时主动发送报告或离开报文。而下行接口则执行路由器行为—发送查询报文并根据报告报文维护组成员关系等。OpenWrt采用igmpproxy软件来支持组播路由。igmpproxy是一个组播路由守护进程,使用IGMP消息来生成动态组播路由表。路由器定义一个上行(upstream)接口,守护进

程作为组播客户端;定义一个或多个下行(downstream)接口,服务于目的网络的客户端。igmpproxy仅使用了IGMP信令,因此适用于组播流量仅从一个邻居网络而来,不适合多级扩展。当前仅有IGMPv2支持。
OpenWrt也支持静态组播路由,在smcroute软件包中,但其限制较多,因此不再介绍。
- 下行端口(家庭网内部)完全执行路由器的角色。
- 上行端口执行主机的角色,当用户加入时,发送成员加入报文。成员全部离开时发送离开报文。

10.4.4 IGMPProxy管理
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

IGMPProxy提供配置文件为其管理接口。配置文件保存在/etc/config目录下,文件名为igmpproxy,示例10-4所示为一个实际配置文件。quickleave打开快速离开模式,在这个模式下代理守护进程一旦收到任何下行接口的离开消息,将立即向上行接口发送离开消息。这个选项在仅有一个客户端时使用。phyint用来配置接口,必须设置的选项有接口名称和流量传输方向,仅支持一个上行网络接口,支持一个或多个下行网络接口。altnet用来定义可以通过的组播源地址。网络地址是“a.b.c.d/n”的数据格式。默认情况下路由器可以从任何网络地址接收组播数据。如果组播源位于因特网的网络上,这个可以定义哪里的流量将被接收。如果不在其地址范围内将不会转发。这对上行接口尤其有用,可以使用它来限制仅指定源地址的组播流量允许通过。
示例10-4:
configigmpproxy
optionquickleave1
configphyint
optionnetworkwan
optiondirectionupstream
listaltnet0.0.0.0/0
configphyint
optionnetworklan
optiondirectiondownstream

IGMP代理还支持网络接口的速率限制。如果速率限制设置为0,将没有速率限制。这个设置可选。thresholdttl定义了网络接口的TTL阈值。如果报文的TTL小于设置值将被忽略。这个设置是可选的,默认设置为1。在UCI配置到igmpproxy进程的配置转换过程中,这两个参数设置为默认值。源代码位于package/igmpproxy下。通过命令opkginstalligmpproxy来安装。当IGMP代理打开时,两个iptables规则将增加到防火墙中并打开转发组播流量。IGMP代理使用的配置文件位于var/tmp/igmpproxy.conf,在启动时由UCI配置转换而来。

10.4.5验证及调试
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

首先我们需要组织一个组播工作环境,最小环境需要一台组播服务器和一台组播客户端及OpenWrt路由器本身3个机器,如果用虚拟机则节省了硬件资源。组播服务器地址为10.0.1.1,运行DHCP服务器,OpenWrt的广域网接口启动DHCP并自动获取IP地址。局域网接口设置地址为192.168.1.1,并且为局域网分配IP地址。PC自动获取路由器分配的IP地址。部署图如图10-2所示。
图10-2IGMP代理组播测试网络
在网络环境配置成功后,依次启动组播服务器、组播代理软件及组播客户端。这时在组播客户端就会收到组播服务器的报文。如果没有收到报文,首先检查防火墙策略是否限制了组播转发,可以直接关闭防火墙进行测试。另外igmpproxy支持调试,使用下面选项

进行调试。
- -d:运行在调试模式,输出所有消息在标准出错中(stderr)。
- -v:输出大量信息,给出两个v将可以看到调试信息。
- -c:指定配置文件。
如果防火墙的默认策略为拒绝转发时,这时使用组播功能就需要关闭防火墙,或者允
许IGMP从wan接口接收并且允许转发组播流量到lan接口,防火墙设置配置如示例10-5
所示。
示例10-5:
configrule
optionsrcwan
optionprotoigmp
optiontargetACCEPT
configrule
optionsrcwan
optionprotoudp
optiondestlan
optiondest_ip224.0.0.0/4
optiontargetACCEPT
optionfamilyipv4

10.5名词解释
-----------------------------------------------------------

- IGMP:是一个由主机和路由器之间使用的相邻IPv4网络建立组播,并维护组成员关系的通信协议。
- 策略路由:策略路由提供了一种比基于目的地址进行路由转发更为灵活的数据包路由转发机制。它可以根据IP报文源地址、目的地址、传输端口、报文长度和优先级等内容灵活地进行路由选择。