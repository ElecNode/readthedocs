07.OpenWrt-网络基础知识
===========================================================

本章首先对网络进行概述,比较了OSI开放系统模型和TCP/IP模型;接着从下到上依次讲述了数据链路层标准以太网,这是工业领域使用最多的链路层标准;接着讲述了TCP/IP协议中的IP协议、ICMP协议以及传输层协议;最后以一个综合案例结束本章.

7.1 概述
-----------------------------------------------------------

TCP/IP协议是因特网的核心协议,目前已成为事实上的标准.TCP/IP是一个分层模型,由4个层次构成:数据链路层、网络层、传输层和应用层.每一层有不同的功能.

数据链路层接收和发送物理层数据.

网络层处理数据网络分组及IP寻址等,包括IP协议、ICMP协议和IGMP协议等.

传输层主要为两台主机的应用程序之间提供端到端通信.主要有两个不同用途的传输协议,TCP-传输控制协议,UDP-用户数据报协议.传输控制协议为主机提供可靠的端到端传输,包括将数据分块交给网络层,并且确认收到分组,以及处理超时机制等,应用层不再用特别处理这种确认机制.用户数据报协议则不用建立网络连接,直接将分组数据传输到另一端,并没有确认机制,数据传输的可靠性由上层来保证.

应用层处理上层的用户逻辑细节.TCP/IP协议层次和OSI互联协议层次的对比如图7-1所示.

应用层
表示层FTP/TFTP/DNS/HTTP/SIP/Telnet/SMTP应用层
会话层
传输层TCPUDP传输层
网络层IPICMPIGMP网络层
数据链路层ARPRARP
数据链路层
物理层

7.1.1 网络设备
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

集线器(HUB)在物理层上实现局域网的互联,可以实现电气信号的恢复和整形.用于将多台计算机连接在一起,以集线器当作网络的中心.

网桥工作在数据链路层,网桥负责分析目的MAC地址字段是否在对方网络上,并据此决定是否将报文转发到对方网络上.相比集线器,其优点是可以起到过滤作用.交换机(Switch)就是一个多端口网桥.

路由器(Router)是网络层设备,一般用于将两个或多个不同网络连接在一起.例如,将局域网接入到互联网就需要用到路由器.所有访问互联网的流量均经过路由器,这样可以屏蔽底层协议的不同,例如宽带接入常用ADSL协议,但家庭内部为以太网传输.防火墙(Firewall)是在两个或多个网络之间用于设置安全策略的一个或多个系统的组合.防火墙起到隔离异常访问的作用,仅允许授权的数据通过,从而保护了网络信息不受非授权用户的存取.

表7-1所示为常见网络设备的比较.

表7-1常见网络设备比较

设备名称工作协议层次优势劣势集线器物理层工作在物理层,性价比高,接入设备可以收到网络上所有报文.现在常用它来调试网络在接入很多设备时,网络性能会直线下降

交换机数据链路层隔离冲突域,每个端口都能达到标称的传输速率,接入后一般不用配置未隔离广播域

路由器网络层隔离广播域和冲突域,用于两个网络互联一般价格较高,接口较少,且需要手动配置

防火墙大多为网络层及网络层以上可以按需隔离两个或多个网络之间的流量一般配置较复杂

7.1.2 计算机网络分类
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

局域网是指传输距离有限,传输速度较高,以共享网络资源为目的的网络系统.局域网有以下特点.
(1)地理分布范围有限.一般在企业内部或者一栋大楼里或者家庭内部.
(2)有较高的传输速率,一般为100Mbit/s以上,现在常见为百兆局域网.
(3)一般采用双绞线作为传输介质,在家庭内部通常使用Wi-Fi,在楼宇之间采用光纤.
(4)拓扑结构采用总线型的以太网传输,易于配置和管理.
(5)网络归单一组织所有.广域网是指覆盖范围广,传输速率低,以数据通信为主要目的的网络系统.

广域网有以下特点.
(1)分布范围广.
(2)传输速率低,现在家庭接入广域网的速率大多在4~50Mbit/s之间.

7.2 数据链路层
-----------------------------------------------------------

7.2.1 以太网
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

以太网是最流行的局域网传输标准,是由施乐公司发明,并由施乐、英特尔和DEC公司组成的联盟发展形成的开放标准.以太网是总线型结构,物理结构采用星状布线.以太网是一种共享传输介质的广播传输技术,就是说网络上所有的设备均能检测到在网络上所有传输的帧.想在网络上传输数据的节点首先监听网络介质是否有数据传输,在检测到线路空闲时,节点开始传输数据并同时监听,确保不会和其他设备传输数据冲突.如果两个节点同时传输数据,监测到冲突后,想要传输数据的节点需要等待一个随机的时间周期才能再次进行传输,这样就减少了再次发生冲突的可能性.

7.2.2 MAC寻址
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

为了在以太网上传输报文,必须有一个寻址系统,也就是对计算机和网络接口命名的方法.每一个计算机的网卡本身均有一个唯一标识,每一个网络接口都有一个物理地址,这个地址就是MAC地址,这个地址也称为网卡物理地址.MAC地址长度为6个字节,表示为12个十六进制的数字.前6个数字为组织唯一标识符(OUI),是由IEEE组织分配的3个字节数字.剩下的6个数字由组织内部编号,企业组织内部需要保证任意两个网卡的MAC编号不能重复.在实际书写中,常用冒号来分隔每一个字节,Mac地址例如:
08:00:27:26:c5:5d.

以太网是一种广播传输技术,网络上的所有节点均能检测到网络介质上传输的帧,但一般只有自身MAC地址和帧目的MAC地址相同才会将内容复制到自己的缓冲区,交给IP层进一步检查IP信息.当网卡工作在混杂模式下时,会将所有侦听到的内容交给上层软件处理,例如TcpDump抓包软件.并不是所有的MAC地址网卡均能使用,有一些特殊的MAC地址,例如FF:FF:FF:FF:FF:FF是以太网广播地址.还有一段地址01:00:5E:00:00:00-01:00:5E:7F:FF:FF用于以太网组播(在组播部分有详细描述).

7.2.3 冲突和冲突域
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

当两个网络节点同时传输数据时就会发生冲突.以太网采用载波侦听及冲突检测回退处理算法来处理冲突,冲突会导致网络传输效率降低,每次发生冲突,所有的传输都要停止一段时间.以太网的核心思想是使用共享的公共传输介质.它是一种广播性网络,任何节点帧的发送和接收过程都使用载波监听多路访问/冲突检测(CSMA/CD)技术,来分配共享信道的使用.在采用CSMA/CD技术的局域网中,帧的发送和接收过程如下.
(1)计算机节点在准备传输数据时,首先要对信道进行监听.
(2)如果信道是空闲时则发送数据,否则继续监听直到信道空闲.
(3)发送数据帧的同时,还要继续监听信道,如果发生冲突,发送信息的节点就会停止发送,同时发送端需要向通信信道发送阻塞信号,以通知其他节点已发生冲突.当若干节点同时检测到信道空闲并发送数据时,数据传输就会遭到破坏,即发生冲突.冲突检测的过程为发送节点发送数据的同时,将其发送信号与总线上接收到的信号进行比较,如果不一致,则有冲突发生.
(4)冲突发生后,随机延迟一段时间再重发,称为冲突退避.如果冲突经常发生则会导致网络性能的快速下降.第一层设备(HUB)不会隔离冲突域.二层及以上设备隔离冲突域.因此二层以上设备将大大提高数据传输性能.

7.2.4 广播域
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

广播是发送到网络中所有节点的数据分组,广播以广播地址来识别,链路层广播地址为FF:FF:FF:FF:FF:FF.在广播时网络中的所有节点均收到该广播报文并做进一步处理.广播域是指能收到广播报文的设备节点集合.第一层设备(集线器)总是转发报文,不对数据进行过滤,将收到的所有信息转发到另一分段.数据帧只是简单的重新生成和重新定时,因此不隔离广播域.第二层设备(网桥和交换机)根据MAC地址转发数据帧,因此将网络划分为多个冲突域.如果目标MAC地址不在本冲突域内,将转发数据帧.因此也不隔离广播域.第三层设备(路由器)不会转发广播报文.路由器为广播域的边界.

7.2.5 ARP协议
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ARP(Address Resolution Protocol)协议用于根据主机的IP地址来查询其网卡MAC地址.在以太网中,真正寻址的是MAC地址,但是在主机传输报文时所知道对端的地址是IP地址.如何通过目标IP地址知道对方的MAC地址,这就是ARP协议的目标.ARP协议通过向局域网中的所有主机发送广播来查询目标IP的MAC地址.当目标主机收到查询请求后和本机IP地址比较,如果一致就通过单播响应查询请求,将自己的MAC和IP对应关系发送给请求源主机.
图7-2所示的是一个ARP查询请求.主机A(10.0.2.15)向网络上发起广播查询请求,询问目标IP为10.0.2.2的MAC地址.由于还不知道目标MAC地址,因此目标硬件地址为广播地址FF:FF:FF:FF:FF:FF.当主机B收到ARP查询报文后,和自己IP地址进行比较发现地址相同,则向主机A回送一个单播的ARP响应.主机A收到后就会更新自己的ARP缓存表.以后再次使用时将在缓存中查询.ARP缓存表采用了老化机制,在一段时间内如果缓存表中的某一个MAC没有使用,就会被删除,这样可以大大减少ARP缓存表的长度,加快查询速度.图7-2ARP广播查询请求通常操作系统均有一个arp命令可以查询当前所保存的ARP缓存.

7.3 IP协议
-----------------------------------------------------------

网络层协议主要包含IP协议、ICMP协议和IGMP协议.

7.3.1 IP报文格式
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

网络层协议主要包括两部分:IP和ICMP.所有的UDP和TCP都采用IP数据格式发送报文,以ICMP格式回报错误.IP协议是不可靠的、无连接的网络协议.不可靠是指它不提供端对端或者逐跳的确认机制,不保证数据包成功传输到对端,其可靠性由上层协议来保证.中间路由器如果检测到错误会丢弃报文,然后发送ICMP消息给源发起者.无连接是指IP报文不保存后续报文信息.IP协议报文格式如图7-3所示.图7-4所示为一个实际报文示例.

版本号IP头长度服务类型报文总长度
标识符flag分片偏移量
TTL协议号IP头校验和
源IP地址
目标IP地址
IP选项(可选)填充
承载数据…
图7-3IP协议报文格式
图7-4一个实际的报文示例


版本号占4个比特,用于表示报文的版本号,IPv4类型报文的版本号为4.IP头长度占4个比特,用于表示IP消息头的4字节倍数长度,最小为5,即5×4字
节,IP消息头最小为20字节.服务类型占8个比特,服务类型提供了服务质量的抽象参数,这些参数用于指导当经过一个数据网络时的实际服务质量参数选择,现在大多数路由器未做实现.报文总长度字段占16个比特(是包含报文包头和数据的整个报文的字节长度),允许最大报文长度是65535字节(这么大的报文长度在网络上是不可能存在的).所有主机必须能接收至少为576字节大小的报文.这个尺寸可以承载512字节的数据加上64字节的包头.假定目的主机可以接收大报文,那就推荐主机仅发送大于576字节的报文,大报文可以提高网络数据传输带宽.
标识符占16个比特,发送者用于标识报文,可用于报文分片和组装.Flag占3个比特,用于分片控制.分片偏移量占13个比特,用于表示报文所属的分片.报文生存时间(TimetoLive,TTL)占8个比特,这个字段指示报文在网络系统中的

最大生存时间.每经过一个路由器,这个值减少处理时间的秒值.如果处理时间小于1,则至少减1,如果这个字段值减少到零,则报文直接丢弃.TTL是报文的最大生存周期,目的是将无法找到目的地的报文丢弃,约束报文的最大生命周期.因为现代路由器的处理速度非常快,这个字段的含义已经演化为经过路由器的跳数.生存时间是数据包生存时间的上限.它由数据包的发送者设定,在网络上每个点,当数据包被处理的时候,逐渐递减.如果生存时间在数据包到达目的地址前达到0值,数据包就被销毁.生存时间可以看作一个自我销毁时间限制.生存时间由发送者设置成允许数据包在网络系统上存活的最大时间.如果数据包在因特网系统上的时间长于生存时间,则数据包必须被销毁.
在Internet头部被处理的每个节点,该头部必须减小,以反映花在处理数据包上的时间.即使无法获得实际花费时间的本地信息,该头部也必须减1.时间以秒为单位衡量(比如,值1表示1秒).因此最大生存时间是255秒或者4.25分钟.由于处理数据包的每个模块至少对TTL减1,即使它在小于1秒内处理完数据报,因此TTL只能被当作数据报可以存在的时间上限.
协议号占8个比特,指示IP协议承载的内容类型,有各种各样的协议内容.例如,
TCP为0x06,UDP为0x11,ICMP为0x01,等等.包头校验和占16个比特,包头域中的值发生改变,例如TTL,这个值在处理过程中将重新计算和验证.校验和是16比特数据,是所有报文头的16比特之和,计算时,校验和为0.校验和用于检查报文传输是否正确,如果错误则直接丢弃,并不会发送ICMP差错消息,因为报头校验和只能检测出IP数据报的头部出现了错误,但并不知道头部的源IP地址字段是否正确,如果源地址出现了错误,那么传输ICMP差错报告将没有任何意义.

校验和提供了处理IP数据报使用到的信息被正确传输的确认,数据可能包含错误.如果校验和验证失败了,IP数据报就被检测到错误的实体立即丢弃.如果IP头部改变,IP头部校验和要重新计算.比如,生存时间的减少,IP选项的增加或者变化,或者由于分片.在IP级别的这个校验和用来防止IP头部的传输错误.

7.3.2 IP地址分类
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

IP地址长度为32位,以4字节数字来表示.互联网的IP地址分为5类,如图7-5所示,分别为A类地址、B类地址、C类地址、D类地址即组播地址和E类地址为保留地址.
E类地址未做进一步的使用规定.前3类地址均为单播地址.

第1类是A类地址,最高位必须是0,然后是7比特的网络编号和24比特的本地地址(主机号).因为最高位为0,所以总共有128(27)个A类网络地址.

第2类是B类地址,最高的两位是10,紧接着是14比特的网络编号和16比特的本地地址.这样就有16384(214)个B类网络地址.

第3类是C类地址,最高位为110,有21位的网络编号和8位的本地地址,这样就有2097152(221)个C类网络地址.

第4类是D类地址,是用于组播的IP地址,最高的4位是1110,不再区分网络编号和本地地址,这类地址不能用于设置物理接口地址.其他以1111开头的地址是E类,是保留地址,未做规定,因此一般不使用该类地址.

图7-5IP地址分类
有一些地址用于固定的用途,其中私有地址(Privateaddress)是保留地址,属于非注册地址,专门为组织机构内部使用.表7-2列出了常见的特殊IP地址块.
表7-2常见的特殊IP地址块
IP地址块用途规范文档

10.0.0.0/8       A类内部私有地址                                            RFC1918
172.16.0.0/12    B类内部私有地址                                            RFC1918
192.168.0.0/16   C类内部私有地址                                            RFC1918
127.0.0.0/8      本地回环地址,用于回路测试,不能路由到主机外部                  RFC1122
169.254.0.0/16   自动配置未成功后分配的IP地址                                RFC3927
0.0.0.0/8        表示本地网络,禁止使用                                       RFC1122
255.255.255.255  受限广播地址,只在本网络上广播                               RFC1812
net.255          网络广播地址                                               RFC1812


A类07位网络号主机号(共24位)
B类10网络号(14位)主机号(共16位)
C类110网络号(21位)主机号(共8位)
D类1110组播地址(共28位)
E类1111保留使用(共28位)

另外,路由器不能路由源地址为0和127开头的报文,也不应该路由目的地址为0和127开头的报文.“127.0.0.0/8”表示本地回环地址.真实的网卡IP地址中不能以十进制“127”作为开头,该类地址中数字127.0.0.1到127.255.255.255用于回路测试.一般采用127.0.0.1代表本机IP地址,用浏览器访问“http://127.0.0.1”就可以测试本机中配置的Web服务器.网络ID的第一个8位组也不能全置为“0”,全“0”表示本地网络.每一个字节都为0的地址“0.0.0.0”对应于当前主机;IP地址中的每一个字节都为1的IP地址“255.255.255.255”是当前子网的广播地址;IP地址中凡是以“1111”开头的E类IP地址都保留用
于将来和实验使用.A、B、C类IP是单播地址,报文转发一般是基于目的IP地址.D类(组播地址)报文转发是基于源地址和目标地址组合.

7.3.3 协议功能
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

IP协议实现了两个基本功能:寻址和分片.寻址是指IP模块在报头中带有地址来传输IP报文到目的地址.传输路径的选择称为路由,这些在路由部分来阐述.分片是指当这些大报文在通过小报文传输网络时,会将大报文分片传输.IP协议使用4个主要机制来提供服务:服务类型、生存时间、选项和校验和.服务类型用来指示要求的服务质量.服务类型是一个抽象的整套参数,这些参数指定了组成因特网的网络中提供的服务选择.这个服务指示类型在选路的时候被路由器用来为某一个特定的网络、下一个网络或者下一个网关选择真实的传输参数.服务类型用于IP服务质量选择.服务类型通过一组参数(优先级、延迟、吞吐和可靠性)来指定.这组参数被映射成数据报传输中的特定网络的真实服务参数.在大多数网络中服务类型并没有特别的使用.生存时间是数据报可以生存的时间上限.它由发送者设置,由经过路由的地方处理.如果报文生存时间为零,则丢弃此数据报.选项提供了在某些情况下需要或有用的控制功能,但是大多数情况下是不必要的.选项包括时间戳、安全和特殊选路等.报头校验和用于保证数据的正确传输.如果校验出错,则抛弃整个数据报.IP协议并没有提供可靠传输机制,没有端对端或者逐跳(hop-by-hop)的确认机制.没有数据的错误控制,只有一个头部校验和,没有重传,没有流控.检测到的错误可以通过IP控制消息协议(ICMP)来报告,该协议在IP协议模块中必须实现.

7.4 ICMP
-----------------------------------------------------------

ICMP协议使用IP协议进行传输报文,是一种面向无连接的协议,用于报告传输出错及控制信息.它对于网络传输具有极其重要的意义,因此每一个网络层模块必须实现该协议.ICMP提供一致标准的出错报告信息.发送的出错报文返回到原始发送数据的设备,发送设备及进程随后可根据ICMP报文确定发生错误的类型,并确定如何才能更好地处理失败的数据包,例如减缓发送、重新发送或者停止发送.ICMP唯一的功能是报告问题,纠正错误的功能由发送方根据实际情况判断处理.我们在网络管理中经常会使用到ICMP协议,比如我们经常使用ping命令,这个“ping”的过程实际上就是发送ICMP查询报文,并根据接收报文判断网络是否可达的过程.还有“traceroute”命令也是基于ICMP协议的,用来探测网络报文的经过路径.

7.4.1 概述
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在Internet系统中,IP协议被用作主机到主机的数据报服务.网络连接设备称为路由器.这些路由器通过网关到网关协议或动态路由协议相互交换用于控制的信息.在数据报传输过程中,可能会遇到一些传输问题,为了报告在数据报传输过程中遇到的错误,网关或目的主机使用ICMP协议来和源主机通信.它使用IP协议作为底层支持,好像它是一个高层协议,但实际上它是网络层的一部分,任何网络层模块的实现必须实现ICMP协议.ICMP消息在以下几种情况下发送:当数据报不能到达目的地时;当网关已经没有缓存去转发;当网关能够引导主机在更短路由上发送.IP并非设计为绝对可靠,这些控制消息的目的是当网络出现问题的时候能提供反馈信息,而不是使IP协议变得绝对可靠.而且并不保证数据报或控制信息能够返回.一些数

据报仍将在没有任何报告的情况下丢失.如果需要高可靠性,使用IP的高层协议必须实现自己的高可靠性控制处理.
ICMP信息通常报告在处理数据报过程中的错误.若要避免信息无限制地返回,对于ICMP消息不会再有ICMP消息发送,而且ICMP信息只在处理数据报偏移量为0时发送,即数据报的第一个分片报文错误时发送.

7.4.2 报文格式
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ICMP消息使用最基本的IP报文头.在IP报文头指明协议为ICMP(0x01),数据位置的第一个8位是ICMP类型域,这个值决定了其后内容的格式.任何标记“未使用”的域用于以后的扩展,现在必须设置为零,但接收时并不使用(除了计算校验和).除非明确的单独说明格式,ICMP报文格式如图7-6所示,头域格式含义如下.
(1)类型.一个8位类型字段,表示ICMP数据包类型,现在支持的类型共10种.
(2)代码.一个8位代码域,表示指定类型中的一个功能,如果一个类型中只有一种功能,代码域置为0.
(3)校验和.数据包中ICMP部分的一个16比特检验和,从ICMP消息的ICMP类型
开始的16位数据的反码之和计算得出.在计算校验码时,校验和设置为零.这些零在发送时会被计算出的校验和取代.Mac层数据(源Mac,目的Mac,二层协议)IP层报文头(版本,消息头长度,源IP,目的IP,上层协议等)类型代码(Code)校验和ICMP数据
图7-6ICMP报文格式
ICMP报文大致可分为3类:差错报文、请求报文和响应报文.具体消息类型如表7-3所示.
表7-3ICMP消息类型
类型含义请求报文响应报文差错报文
0echo响应消息*
3目的不可达报文*
4源抑制消息*

续表
类型含义请求报文响应报文差错报文
5重定向消息*
8echo请求消息*
11超时消息*
12参数问题消息*
13时间戳请求消息*
14时间戳响应消息*
15信息请求消息*
16信息响应消息*

7.4.3 差错报文
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

网络出现异常情况时,就需要发送一份差错报文,该报文始终包含源报文的IP首部和产生ICMP差错报文的IP数据报的前8个字节.这样接收ICMP差错报文的主机就会把它与某个特定的协议(根据IP数据报首部中的协议字段来判断)和用户进程(根据包含在IP数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号来判断)联系起来.
以下各种情况即使出错也不会导致产生ICMP差错报文.
(1)ICMP差错报文.
(2)目的地址是广播地址或组播地址.
(3)作为链路层广播的数据报.
(4)不是IP分片的第一片.
(5)源地址不是单个主机的数据报文,也就是说源地址不是零地址、环回地址、广播
地址、组播地址或E类地址.
以下针对ICMP差错报文的类型进行分析.
(1)ICMP目的不可达消息.如果路由器因为没有去往目的地址路由而不能转发报

文,则路由器必须产生目的不可达消息,是代码域为零(网络不可达)的ICMP消息.如果报文需要转发到的主机,已经转发到最后一跳路由器(主机直连的网络),路由器判断不能到达目的主机,则路由器必须产生代码域为1的目的不可达ICMP消息(主机不
可达).
(2)ICMP重定向消息.网关G1从所连接的网络的一个主机上收到IP报文.网关检查路由表获知下一个路由器G2的地址和目的地址网络X.如果G2和源主机在同一个网络上,那重定向报文将发给主机.重定向消息告知主机发往目的网络X直接发往G2是最短路径.
(3)ICMP超时消息.IP数据包中有一个字段生存时间(Timetolive,TTL),生存时间值在每一个机器处理报文时都会减少,直到减到0时该IP数据包被丢弃.此时,路由器将发送一个ICMP超时消息给源主机.
(4)源抑制消息.当主机经过路由器发送数据到另一主机时,如果速度达到路由器或者链路的饱和状态,路由器发出一个ICMP源抑制消息.路由器不应该产生源抑制消息,因为实践表明对减少网络带宽没有价值.
(5)参数问题.如果网关或主机处理报文时发现一个消息头参数问题,在它不能完成处理这个报文时,必须丢弃这个报文.例如,不正确的选项.网关或主机通过参数错误消息通知源主机.这个消息仅用于如果错误引起报文丢弃的情况.

7.4.4 查询报文及响应报文
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

(1)ICMPECHO消息.用于进行通信的主机或路由器之间,判断发送数据包是否成功到达对端的消息.可以向对端主机发送ECHO请求消息,接收对端主机回来的ECHO应答消息.
(2)ICMP地址掩码消息.主要用于主机或路由器想要了解该网络中主机数量的情况.可以向那些主机或路由器发送ICMP地址掩码请求消息,然后通过接收ICMP地址掩码应答消息获取子网掩码信息.
(3)ICMP时间戳消息.可以向主机或路由器发送ICMP时间戳请求消息.接收到的数据(时间戳)的消息在回复时再带上另外一个时间戳返回.时间戳是自午夜UT时间的32位毫秒值.现在已经很少使用.

7.4.5 ping
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ping是利用ICMPECHO请求消息,产生一个ECHO响应消息.ping使用ICMP报头,并使用填充字节填满报文.当源主机向目标主机发送了ICMP回显请求数据包后,它期待着目标主机的应答.目标主机在收到一个ICMP回显请求数据报文后,它会交换源、目的主机的IP地址,然后将收到的ICMP回显请求数据报文中的数据部分原封不动地封装在自己的ICMP回显应答数据报文中,然后发回给发送ICMP回显请求的一方.如果校验正确,发送者便认为目标主机的IP层服务正常,也即IP层连接畅通.

示例7-1在终端上ping百度的域名,发现访问百度的IP地址延迟仅3.829毫秒,而
且丢包率为0%.
示例7-1:

zhang@zhang-laptop:~$pingbaidu.com -t5
PINGbaidu.com(220.181.57.216)56(84)bytesofdata.
64bytesfrom220.181.57.216:icmp_seq=1ttl=53time=3.88ms
64bytesfrom220.181.57.216:icmp_seq=2ttl=53time=3.12ms
64bytesfrom220.181.57.216:icmp_seq=3ttl=53time=4.91ms
64bytesfrom220.181.57.216:icmp_seq=4ttl=53time=3.49ms
64bytesfrom220.181.57.216:icmp_seq=5ttl=53time=3.73ms
---baidu.compingstatistics---
5packetstransmitted,5received,0%packetloss,time20067ms
rttmin/avg/max/mdev=3.128/3.829/4.910/0.601ms
当使用ping来诊断和测试网络时,一般通过以下步骤来执行.

(1)首先ping本机IP.判断本地接口是否启动以及工作正常.
(2)其次ping网关地址.根据响应判断局域网工作是否正常,结束时会有最小/平均/最大来回时间统计和报文是否丢失统计.
(3)最后ping目的主机地址.判断本机和目标主机之间的路由是否正确以及目的主机是否工作正常.

7.4.6 TraceRoute
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TraceRoute程序用于侦测源主机和目的主机之间所经过的路由情况,可以跟踪路由数
据包在IP网络上传输到一个指定主机的路径,参数含义如表7-4所示.它利用IP协议的
生存时间(TTL)字段来试图引发网关ICMP超时响应.在每个网关的路径上发送ICMP
超时响应到源主机上.源主机发送的报文TTL从1开始逐渐增加,直到收到ICMP回显请
求响应消息或达到最大跳数值为止.这意味着已经到达主机或者超过30跳了.默认每一
个相同的TTL会发3个探测报文,如果路径不同会都输出.如果在5秒钟没有响应则会以
星号(*)显示.
唯一必须的参数是目的主机IP地址.可选参数有探测包长度,默认为60字节.测试
中发现很多路由器对于UDP数据如果是TTL原因数据丢包不会发ICMP超时差错消息,
而对ICMP请求会返回ICMP超时响应.因此在使用时,建议使用-I参数来指明使用ICMP
协议来发起请求.
在Windows下可以使用tracert替代,但不需要指定使用的协议.功能基本相同.
表7-4traceroute参数含义
参数含义
-I--icmp使用ICMPECHO请求来进行traceroute
-T使用TCPSYN请求来traceroute,使用端口80
-z
两个探测报文之间的最小等待时间(默认为0),在0和10秒之间.如果数字小于10,单位为秒,如果大于10,那数字就是以毫秒为单位
-qnqueries每一跳发送的探测报文数量.默认是3
-wwaittime设置等待响应消息的时间.默认是5秒
-m设置最大的跳数,默认为30跳
-n不解析IP地址为域名

7.5 传输层协议
-----------------------------------------------------------

互联网的传输协议主要有传输控制协议TCP和用户数据报协议UDP两种协议.路由器一般工作在IP层,不处理传输层协议,但智能路由器一般带有防火墙功能,需要处理端口号.因此这里简要介绍端口号.UDP报文非常简单,仅在IP报文上增加了8字节数据,并且在传输数据之前不需要首先建立连接,远程主机在接收到数据后也不需要确认,因此网络通信开销比较小.图7-7所示为UDP消息的报文格式.源端口(16比特)目的端口(16比特)UDP报文长度(16比特)UDP校验和(16比特)UDP数据……

图7-7UDP报文格式

源端口,是发送者进程使用的端口,占有16比特,因此合法范围为1~65535.目的端口,是接收者进程使用的端口,和源端口一样占用16比特,一般特权用户使用1~1024,非特权用户使用其他端口.UDP报文长度,包含UDP消息包头和数据的总长度.UDP校验和,用于验证传输数据是否正确.这个字段是可选的,如果字段为0,就不进行校验.另外一个传输层协议是传输控制协议(TCP),和UDP协议完全相同的部分是使用了源端口号和目的端口号,不同的是提供了可靠的数据传送.传输数据之前需要进行3次握手连接,并在传输的中间过程进行确认.这带来了一些便利,例如保证了数据到达目标地址,如果没有到达将立即重传.但这同时也带来了一些创建网络连接的开销.路由器一般很少处理IP层以上的内容,这里不再详述TCP协议,请参考RFC793.

7.6 综合
-----------------------------------------------------------

通过前面的学习,我们可以回答两个相同网络主机和不同网络主机是如何进行数据传
输的了.网络如图7-8所示,当主机A发送一个IP报文时,各个层次及协议是如何进行
转换的,如何将报文逐层转到下层报文,然后发往目的地址的？我们来分析主机A
(192.168.6.100)要发送报文到主机C(192.168.6.102)上,和主机A发送报文到8.8.8.8这

个网络主机上这两个过程.
图7-8组网网络环境图
主机A发送报文到主机C的各层协议模块工作过程,例如在主机A上执行ping
192.168.6.102.
(1)在主机A按照ICMP协议组装ICMP请求报文.在组织ICMP请求完成后,使用IP协议来发送报文.
(2)在IP层发送报文时,首先查看目标地址路由是否可达,如果路由不可达那就退出,并提示“Networkisunreachable”等类似的错误.这里的IP地址配置为同一子网,因此路由可达.那就首先查看目标IP的MAC地址是否在本机的缓存上,如果存在,则使用目标MAC将报文直接封装为第二层的帧,再经物理层信号编码发往网络传输介质上.
(3)如果ARP缓存中没有目标IP地址,那就发送ARP广播来请求目标IP的MAC地址.目标MAC地址填写为广播地址FF:FF:FF:FF:FF:FF.ARP数据帧经物理层线路进入交换机端口,交换机通常会进行源MAC地址学习和目的端口查找,如果找不到目标MAC所在的网口,则在除报文源端口外的全部端口广播ARP查询请求.此时主机B和C均收到ARP查询请求,主机B发现目IP地址和本机地址不同,则静悄悄地丢弃,不做进一步处理.主机C收到ARP查询请求后判断和本机IP地址相同,则C响应ARP请求,将主机C的IP地址和MAC地址的对应关系以单播形式回送给主机A.这时交换机可以再次学习到C的MAC地址与端口对应关系,在下次ARP查询和传送数据时就不再对所有端口进行广播.
(4)如果主机A收到主机C的MAC地址的ARP查询响应,那就将目的MAC填写为C的MAC地址,源MAC填写为自己的MAC地址,封装为二层帧数据中交给物理层来发送.当再次进行主机A向主机C发送数据,将直接使用缓存中C的MAC地址进行封装,不再进行MAC地址的ARP广播查询.
(5)如果此时主机C恰好关机,主机A没有收到ARP响应消息,那就提示用户“Requesttimedout”或“DestinationHostUnreachable”等信息.
(6)当主机C收到数据帧之后,首先判断目标MAC地址是否和本机匹配,如果不匹配则静悄悄地丢弃,不做任何处理.如果和本机MAC相同则交给IP层进行处理.IP层收到报文后,首先判断目的IP地址是否和本机IP相同,如果不同则丢弃报文;如果相同则交给上层协议处理,这里交给ICMP协议模块来处理.这样报文便单向处理完成.响应报文和请求报文一样,也是同样的发送及处理过程.我们再来看看主机A发送报文到主机E的各层协议模块工作过程,这个过程两个节点不在同一个网络上,因此需要经过路由器的处理.例如在主机A上执行ping8.8.8.8.
(1)如果主机A路由查询判断到达目标主机必须通过下一跳网关地址.那进行ARP查询时,就查询网关地址的MAC地址.路由器将响应ARP请求,将自己的MAC地址和IP发送回来.
(2)如果主机A在进行路由查询时,发现目标主机直接经过网卡设备可以到达,例如主机A的默认路由配置为接口路由,没有配置默认网关地址.那进行ARP查询时,就直接请求目标IP的MAC地址.如果路由器D有ARP代理功能,将会响应ARP请求,并将自己的MAC地址和目标IP对应起来.
(3)主机A收到网关的ARP响应报文后,目标IP地址不变,将目标MAC填写为网关MAC地址,然后将数据帧经过物理网卡发送到链路上.
(4)主机D收到报文后,进行MAC地址检查,如果目标MAC地址和自己的MAC地址匹配,则进一步转到IP层进行处理.IP模块判断目标IP地址不是本机IP地址,如果主机D没有配置为路由器,那就直接丢弃这个报文;如果主机D配置为路由器,则将报文交给IP转发模块进行处理.IP转发模块会将报文TTL减一,并再次进行路由查询过程和ARP查询过程,然后将数据报文转发到离目标地址E更近的一个路由器上.在中间转发的过程中,数据报文的目标IP地址和源IP地址始终不变,源MAC地址和目标MAC地址在每一跳中均根据其物理连接进行修改.


集线器:主要功能是对接收到的信号进行整形放大,以扩大网络的传输距离,同时把所有节点集中在以它为中心的节点上.它工作于OSI参考模型第一层,即物理层.交换机:同时连通许多对端口,使每一对相互通信的主机都能像独占通信媒体那样,进行无冲突的传输数据.它是基于MAC地址识别和完成以太网数据帧转发的网络设备.它工作于OSI参考模型的第二层,即数据链路层.路由器:又称网关,是用于连接逻辑上分开的多个网络,可以隔离网络之间的广播数据.它工作在OIS参考模型的第三层,即网络层.TTL(Timetolive):IP报文的生存时间,每经过一个路由器,TTL至少减1,为零时报文不再转发.