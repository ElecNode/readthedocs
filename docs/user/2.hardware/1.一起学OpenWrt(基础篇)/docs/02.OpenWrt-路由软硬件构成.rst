02.OpenWrt-路由软硬件构成
===========================================================

2.1 OpenWrt硬件构成
-----------------------------------------------------------

.. figure:: ../media/mt7628开发板.jpg
   :alt: OpenWrt开发板
   :align: center

------

2.1.1 电源
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

开发板使用的是12V的电源供电,也可以使用5V的电源供电.但在后面介绍使用LTE联网时如果电源功率较小可能有无法连接网络的情况.在一些国外的路由器上会有开关,这是国外的标准,国内的路由器很少配电源开关.

2.1.2 复位按键
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

一般的路由器都有复位按键,例如忘记路由器后台管理界面登录密码的时候,可以通过长按复位按键数秒恢复出厂设置.这个按键就是一个普通的gpio只是作为reset按键作用.在有些路由器reset按键也被用作wps作用.

2.1.3 cpu
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

多数的路由器是使用mips架构的芯片,比如教程使用的开发板上mt7628an芯片就是mips架构.也有一些arm架构的路由器如博通的路由器芯片.当然在一些软路由上也使用x86架构的芯片.

2.1.4 内存
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

教程使用的内存是ddr2,拥有64M的内存,手机系统一般要求都是2G起步,手机或者pc等多数的内存都用在图形处理上,而路由上很少有图形化桌面,所以系统的开销也小很多.

2.1.5 硬盘
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

OpenWrt上使用的是flash作为存储介质,为了方便理解把它称为硬盘.如最常用的spi flash价格很便宜,教程开发板上搭载的是16M的flash,也有搭载8M flash,但是有些开发可能会有容量不够的情况,所以最常用的是16M flahs.

2.1.6 网口
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

开发板拥有5个网口,其中1个作为wan,4个作为lan.4个lan口作为一个整体,同时启用,同时关闭.lan口也可作为普通的gpio.


2.2 OpenWrt软件构成
-----------------------------------------------------------

2.2.1 bootloader
-----------------------------------------------------------

这里使用uboot作为系统引导,也有一些其他bootloader,linux系统的主要引导方式是uboot.

uboot可以通过如下的flash分区结构了解到,flash中数据按照分区存放.在板子上电时候首先启动uboot,完成系统启动前必要的配置.进入系统后就和uboot没有任何关系了,这和使用的电脑的bios是类似的.所以一般的OpenWrt开发主要就是系统固件的开发,而不是uboot的开发,uboot可以刷breed等知名的uboot镜像.
   
.. code-block:: console
   :caption: flash分区结构
   :linenos:

   [    0.680405] Creating 4 MTD partitions on "spi0.0":
   [    0.689942] 0x000000000000-0x000000030000 : "u-boot"
   [    0.702696] 0x000000030000-0x000000040000 : "u-boot-env"
   [    0.714684] 0x000000040000-0x000000050000 : "factory"
   [    0.727803] 0x000000050000-0x000001000000 : "firmware"
   [    0.739537] 2 uimage-fw partitions found on MTD device firmware
   [    0.751364] Creating 2 MTD partitions on "firmware":
   [    0.761215] 0x000000000000-0x00000021f407 : "kernel"
   [    0.771050] mtd: partition "kernel" doesn't end on an erase/write block -- force read-only
   [    0.790570] 0x00000021f407-0x000000fb0000 : "rootfs"
   [    0.800484] mtd: partition "rootfs" doesn't start on an erase/write block boundary -- force read-only
   [    0.819961] mtd: device 5 (rootfs) set to be root filesystem
   [    0.832363] 1 squashfs-split partitions found on MTD device rootfs
   [    0.844708] 0x0000007b0000-0x000000fb0000 : "rootfs_data"


2.2.2 固件
-----------------------------------------------------------

固件也是OpenWrt开发的重头戏,固件也是单独放在flash的分区中,固件中包括linux和rootfs两个部分.



